## 双活负载均衡架构

### VIP 32 bits mask and lo interface

当前主机的路由表...

```bash
Destination 	Gateway	       Genmask	          Use Iface
192.168.247.0	0.0.0.0	       255.255.255.0	   lo
192.168.247.0	0.0.0.0	       255.255.255.0	   eth0
0.0.0.0	       192.168.247.2	0.0.0.0	           eth0
```

（Gateway是0.0.0.0或者*表示目标是本主机所属的网络，不需要路由）
注意：上面的lo是我假设的，为了方便下面的说明，实际在Linux中`route -n`是看不到lo接口的设备的，因为它不对外。

假设当前目标IP 192.168.247.1，**VIP**为192.168.247.100

lo网卡 192.168.247.100 & 255.255.255.0 = 192.168.247.0
eth0网卡 192.168.247.12 & 255.255.255.0 = 192.168.247.0
目标IP地址 192.168.247.1 & 255.255.255.0=192.168.247.0

然后我们需要明白一个事，叫**IP最长匹配原则**。因此不会走最后的默认网关192.168.247.2。而且由于&运算发现目标IP和主机在同一网段内，因此会走上面两条，而且上面两条其实都会匹配成功，但是，**由于是环回网卡一种特殊的网络接口，不与任何实际设备连接，而是完全由软件实现。而且lo环回网卡离内核近，所以在路由表中为第一条，所以数据包会走lo环回接口。**

> 路由最长匹配原则，“能够完全匹配的最长”的，在能够匹配的情况下，越长越精确。

而环回接口有一个特点，就是接收到的数据包又会发回给本机，也就是说回环网卡是自己和自己玩，因此如果走的是环回接口发送数据包，永远也发不出去，因此我们不能让数据包走环回接口，所以需要将掩码设置成255.255.255.255，这样&运算192.168.247.1  ！=192.168.247.100

```bash
Destination   	Gateway	   Genmask	          Use Iface
192.168.247.0	0.0.0.0	   255.255.255.255	   lo
192.168.247.0	0.0.0.0	   255.255.255.0	   eth0
0.0.0.0	     192.168.247.2	0.0.0.0	           eth0
```

因此就不会走我们的环回接口发送数据包，而是走eth0发送数据包。然后通过eth0向交换机广播，获取192.168.247.1地址的MAC地址，将数据包发送过去就完成了相应的过程。


### 基于DNS轮训

配置两套主备模式的负载均衡器，分别配置VIP A和VIP B。在DNS server测针对同一域名，同时注册VIP A和VIP B。然后在请求域名的时候，dns通过轮训返回VIP A或者 VIP B。在服务端，需要通过memcached/redis集群来共享不同节点的内存数据。从而保证session的持久性

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/Round-robinDNS.png)



### 基于ECMP

此方案中，不存在主备模式的负载均衡器，所有负载均衡器均为主模式，配置同一VIP。在router测，利用quagga模拟ospf，可以看到到达VIP的链路有两条，当请求到达router的时候，会将流量分配到两台主负载均衡器上。

> quagga是一个实现ospf的路由软件，用于模拟ospf协议。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/ecmp-routing.png)

由于接收数据包的目的IP是VIP，所以需要将vip绑定到lo网卡，因为lo:vip不是用来通信的，所以这里的一定设置/32位子网掩码。

lo网卡是loop，不会将数据转发出去，所以需要将掩码设置成32位。当数据包进来时，会使用掩码进行判断是否属于同一子网，进而选择网关进行转发，当lo interface设置成32 bits时，就不会有数据包进入lo 接口。

### 引用

1. https://blog.csdn.net/SmallCatBaby/article/details/89876508
2. https://lk668.github.io/2020/12/13/2020-12-13-ECMP/