## Network Knowledge Quick Start

### 基础名称

#### LAN

LAN，全称Local Area Network，中文名叫做**局域网**。

具体到路由器，我们一般组网，都是组建的LAN网络，用户在局域网里通信、传输文件。

> 一般路由器的LAN口会图上颜色和WAN口区分，一般LAN口数目会多于WAN口。

其获取到的是内部IP，LAN 内部是交换机。我们可以不连接 WAN 口，把路由器当做普通交换机来使用。

一般用到的LAN的场景：

1，接电脑的网线，需要插到路由器的LAN口。

2，二级路由，一般都是从上级路由的LAN口接线。

#### WAN

WAN，全称Wide Area Network，中文名叫做广域网。

WAN是一种跨越大的、地域性的计算机网络的集合。通常跨越省、市，甚至一个国家。广域网包括大大小小不同的子网，子网可以是局域网，也可以是小型的广域网。

WAN：接外部 IP 地址用，通常指的是出口，转发来自内部 LAN 接口的 IP 数据包。

基本每个路由器都有WAN口，当然也有路由猫这种特例。

> 一般路由器都会有一个WAN口，也有多个WAN口的路由。

WAN的应用场景：

1，从猫引出的来网线，要插到路由器的WAN口。

2，二级路由，上级网线插到二级路由的WAN口。

#### WLAN

WLAN，全称Wireless LAN, 无线局域网。

和LAN不同，WLAN的数据通过电磁波传输，也就是常说的空气传输。WLAN 利用电磁波在空气中发送和接受数据，而无需线缆介质。

WLAN 使用 ISM (Industrial、Scientific、Medical) 无线电广播频段通信。WLAN 的 802.11a 标准使用 5 GHz 频段，支持的最大速度为 54 Mbps，而 802.11b 和 802.11g 标准使用 2.4 GHz 频段，分别支持最大 11 Mbps 和 54 Mbps 的速度。最新的11AC已经达到竟然的1.3Gbps。

##### WiFi

应用 WLAN 的实现协议有很多，其中最为著名也是应用最为广泛的当属无线保真技 术——Wi-Fi，它实际上提供了一种能够将各种终端都使用无线进行互联的技术， 为用户屏蔽了各种终端之间的差异性。 在实际应用中，WLAN 的接入方式很简单，以家庭 WLAN 为例，只需一个无线 接入设备-路由器，一个具备无线功能的计算机或终端（手机或 PAD），没有无线 功能的计算机只需外插一个无线网卡即可。

Wireless Fidelity 基于IEEE 802.11b标准的无线局域网, 简单来说就是wlan的一部分，但随着WiFi的普及，很多人也把WiFi与WLAN等同。

#### VLAN

虚拟局域网(Virtual Local Area Network，VLAN)
虚拟局域网( VLAN )，是指网络中的站点不拘泥于所处的物理位置，根据需要灵活划分不同的逻辑子网中的一种网络技术。

每一个VLAN分形成一个虚拟的局域网络，共享一个单独的广播域。

##### 管理VLAN

管理VLAN是指，负责传输通过CAPWAP隧道转发的报文，包括管理报文和通过CAPWAP隧道转发的业务数据报文。

##### 业务VLAN

业务VLAN负责传输业务数据报文。如果不配置的话，默认业务VLAN为VLAN1。

##### VLAN1

VLAN1是比较特殊的VLAN，标准的三层交换机，为了做到零配置使用，会默认将端口加入VLAN1。

采用零配置，会出现VLAN1的广播域过大的问题，容易在VLAN1内形成泛洪，因此不推荐WLAN网络规划时使用VLAN1作为管理VLAN或者业务VLAN。

#### 冲突域

Collision Domain

以太网是一种基于CSMA/CD（Carrier Sense Multiple Access/Collision Detect，载波侦听多路访问/冲突检测）的共享通讯介质的数据网络通讯技术，当主机数目较多时会导致冲突严重、广播泛滥、性能显著下降甚至使网络不可用等问题。

形象的说，在此方法下每个接入网络的人都有发送消息的权利，但在同一时间只能有一个人占当前的线路，否则会发生混乱，因此每个人需要在发生前进行载波侦听（是否有人正在占线），如果有则需要等待后才可以发送消息。

当两端同时发生冲突时，则会发生冲突检测，会话终止并随机等待一段时间后再开始的判断。

连接在同一导线上的所有工作站的集合，或者说是同一物理网段上所有节点的集合或以太网上竞争同一带宽的节点集合。也就是说，用Hub或者Repeater连接的所有节点可以被认为是在同一个冲突域内，它不会划分冲突域。由于广播域被认为是OSI中的第二层概念，所以像Hub和交换机等第一，第二层设备连接的节点被认为都是在同一个广播域。

##### LAN and 冲突域

通过路由器/交换机（三层交换机）实现LAN互联可以解决冲突（Collision）严重的问题。

一组与同一条物理介质相连的设备，其中任何两台设备同时访问该介质都将导致冲突，冲突域中同一时间内只有一台机器能够发送数据。



#### 广播域

网络中一组相互接收广播消息的设备。

二层广播帧覆盖的范围就是广播域；二层单播帧覆盖的范围就是冲突域。

第一层设备如集线器，与之连接的所有设备都属于同一个冲突域和同一个广播域；

第二层设备如交换机和网桥，将网络划分成多个网段，每个网段是一个独立的冲突域，但是相连的所有设备是一个广播域，交换机的每个端口就是一个冲突域；
第三层设备如路由器，将网络划分为多个冲突域和广播域。



#### BUM

BUM(broadcast&unknown-unicast&multicast,广播&未知单播&组播)

#### ARP/ND

ND： Neighbor Discovery

ARP： Address Resolution Protocol

邻居发现协议NDP（Neighbor Discovery Protocol）是IPv6协议体系中一个重要的基础协议。邻居发现协议替代了IPv4的ARP（Address Resolution Protocol）和ICMP路由器发现（Router Discovery），它定义了使用ICMPv6报文实现地址解析，跟踪邻居状态，重复地址检测，路由器发现以及重定向等功能。

#### CT

Communication Technology

>  IT, Information Technology
>
> IT业和CT业的壁垒越来越不明显，现在已经形成了一个新的行业–ICT业，Information Communication Technology(信息、通信技术)。

CT业被称为电信业，Telecommunication。那是因为最早期的通信都是电报、电话之类的技术，所以也被称为电信技术。

通信业的企业又分为运营商、通信制造业、通信服务支持，一些通信业的施工单位等。

通信业的运营商在国内我们比较熟悉的是中国移动、中国联通、中国电信，现在又多了一个中国广电。

通信业的制造业在中国比较有名气的是三个：华为、中兴、信科。全球范围内，通信业的制造业比较强大的也就是诺基亚、爱立信、华为、中兴这四家了。


#### P、PE、CE

P（Provider）、PE（Provider Edge）、CE（Customer Edge）属于mpls vpn里的概念。在VPN概念中，把整个网络中的路由器分为三类：

**第一类，运营商骨干路由器（P）**

**第二类，运营商边缘路由器（PE）**，PE充当IP VPN接入路由器，即Provide的边缘设备。服务提供商骨干网的边缘路由器，它相当于标签边缘路由器（LER）。PE路由器连接CE路由器和P路由器，是最重要的网络节点。用户的流量通过PE路由器流入用户网络，或者通过PE路由器流到MPLS骨干网。

**第三类，用户边缘路由器（CE）**，服务提供商所连接的用户端路由器，CE路由器通过连接一个或多个PE路由器，为用户提供服务接入。CE路由器通常是一台IP路由器，它与连接的PE路由器建立邻接关系。

**用户站点**：用户端网络的总称，一个用户站点可以通过一条或多条链路连接服务提供商的骨干网络。

#### CR、AR、BR、SR

CR（Core Router，核心路由器）、AR（Access Router，接入路由器）、BR（Broadband Router，汇聚路由器）、SR（Service Router，业务路由器）

一般的ip网络中，根据其拓扑结构，可以把路由器分为边缘路由器BR，接入路由器AR，核心路由器CR。

PE或者AR基本是一个概念，某些运营商称为PE比如联通，某些运营商称为AR比如移动，叫做接入路由器，是CE的直接上级路由器。

所有的软交换站点接入CE都上联到PE或者AR，然后PE或者AR接入运营商的IP骨干网。

三大运营商不同的叫法，实质上是同一个设备作用：

**运营商骨干（核心）路由器---运营商边缘（接入）路由器---用户边缘路由器<=>P（CR）-PE（AR)-CE（BR）**

AR\BR\CR\SR都可以做PE\CE\P设备，一般CR\BR是不会做PE设备的，只做P设备，AR作为PE设备。

除非网络完全建设开，CR\BR在做P设备时兼做PE设备，SR为业务路由器，一般做PE设备。



### Loopback Interface

#### VIP 32 bits mask 

当前主机的路由表...

```bash
Destination 	Gateway	       Genmask	          Use Iface
192.168.247.0	0.0.0.0	       255.255.255.0	   lo
192.168.247.0	0.0.0.0	       255.255.255.0	   eth0
0.0.0.0	       192.168.247.2	0.0.0.0	           eth0
```

（Gateway是0.0.0.0或者*表示目标是本主机所属的网络，不需要路由）
注意：上面的lo是我假设的，为了方便下面的说明，实际在Linux中`route -n`是看不到lo接口的设备的，因为它不对外。

假设当前目标IP 192.168.247.1，**VIP**为192.168.247.100

lo网卡 192.168.247.100 & 255.255.255.0 = 192.168.247.0
eth0网卡 192.168.247.12 & 255.255.255.0 = 192.168.247.0
目标IP地址 192.168.247.1 & 255.255.255.0=192.168.247.0

然后我们需要明白一个事，叫**IP最长匹配原则**。因此不会走最后的默认网关192.168.247.2。而且由于&运算发现目标IP和主机在同一网段内，因此会走上面两条，而且上面两条其实都会匹配成功，但是，**由于是环回网卡一种特殊的网络接口，不与任何实际设备连接，而是完全由软件实现。而且lo环回网卡离内核近，所以在路由表中为第一条，所以数据包会走lo环回接口。**

> 路由最长匹配原则，“能够完全匹配的最长”的，在能够匹配的情况下，越长越精确。

而环回接口另一个特点，就是接收到的数据包又会发回给本机，也就是说回环网卡是自己和自己玩，因此如果走的是环回接口发送数据包，永远也发不出去，因此我们不能让数据包走环回接口，所以需要将掩码设置成255.255.255.255，这样&运算192.168.247.1  ！=192.168.247.100

```bash
Destination   	Gateway	   Genmask	          Use Iface
192.168.247.0	0.0.0.0	   255.255.255.255	   lo
192.168.247.0	0.0.0.0	   255.255.255.0	   eth0
0.0.0.0	     192.168.247.2	0.0.0.0	           eth0
```

因此就不会走我们的环回接口发送数据包，而是走eth0发送数据包。然后通过eth0向交换机广播，获取192.168.247.1地址的MAC地址，将数据包发送过去就完成了相应的过程。

#### 递归路由：一发入魂，666

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。

啧啧啧，不是递归路由的错误路由，路由器直接丢掉。

R1和R2的互联地址为R1端：10.48.12.1/30，R2端：10.48.12.2/30。R2的Loopback 0地址为10.48.255.2，R2右边的网段为10.112.127.0/24。

递归路由怎么理解？其实简单的说，就是这条路由的下一跳地址，并不在与当前设备直连的下一跳地址。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/loopback-routing.jpg)

R1和R2的互联地址为R1端：10.48.12.1/30，R2端：10.48.12.2/30。R2的Loopback 0地址为10.48.255.2，R2右边的网段为10.112.127.0/24。

R1内有一条路由，目标网段是10.112.127.0/24，而下一跳地址是10.48.12.2，则这条路由就不是递归路由了。因为10.48.12.2这个下一跳地址就直接在与R1直连的设备（R2）上。

如果在R1上看到一条路由的下一跳地址是与R1直连设备的互联地址，则这条路由就不是递归路由。通常情况下，通过RIP、EIGRP、OSPF这样的IGP学习过来的路由都不是递归路由。

非递归路由，只需要查找一次路由表。

但如果R1到达10.112.127.0/24的下一跳地址是R2的Loopback 0地址，此时Loopback 0地址并不是与R1直连的互联地址。那么10.112.127.0/24对于R1来说就成了一条递归路由了。

如果碰到递归路由的时候，数据应该怎么走呢？

比如，数据到了R1，要去10.112.127.0/24，但是在R1上，10.112.127.0/24的下一跳地址是R2的Loopback 0地址-10.48.255.2。那么在这个时候，R1就要先找到达10.48.255.2的下一跳，才能把数据发送给10.112.127.0/24

数据要去10.112.127.0/24这个网段，但是这条路由在R1上是递归路由。所以，数据先查找去10.48.255.2的下一跳地址（即10.112.127.0/24的下一跳的下一跳），找到10.48.255.2的下一跳是10.48.12.2。

> 这个例子中VIP只指向了一个IP，如果这个vRouter是个host，而且有两个网卡，这个vip就可以实现灾备了，一个网卡挂了还可以走到另一个网卡。

于是，R1先把数据发送到10.48.12.2，由10.48.12.2再把数据发送到10.48.255.2，再发送到10.112.127.0/24上。

如果R1上，到10.48.255.2的路由不可达，则10.112.127.0/24这条递归路由也无效。**也就是说，递归路由的下一跳地址不可达，则递归路由失效。**

在刚才说的那个例子中，因为R1和R2之间就那么一条链路，所以R1到10.112.127.0/24的路由是不是递归路由，都不会影响到数据流量的走向。再来看下面一个例子，就可以看到递归路由的走向问题了：

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/loopback-routing-2.jpg)

此时，R1要发送数据去10.112.127.0/24，则需要先到达10.48.255.3（先找到10.48.255.3）的下一跳。从图上来看，R1到达10.48.255.3，可以走R2方向的10.48.12.2，也可以走R4方向的10.48.14.2。那到底是走哪头呢？这个就要看R2和R4传递给R1的，关于10.48.255.3的路由谁的优先级更高了。

所以，在递归路由的情形下，数据的走向实际上是由如何到达它的下一跳地址的走向来决定的。

在BGP的知识点内，就有这么一条：BGP路由的下一跳地址属性（Next-Hop属性）是BGP邻居的更新源地址。因为iBGP邻居通常是用Loopback 地址，所以iBGP的路由也通常是递归路由。虽然教材上说iBGP用Loopback地址做更新源是为了更稳定，但这也不代表iBGP就必须要用Loopback地址做更新源，因为在一些极端的场合下，递归路由可能造成路由环路。

####  loopback 主机网卡双活

添加一个32位掩码的IP地址到Loopback接口：
**ip addr add dev lo 33.33.33.33/32**
再添加两条路由
**ip route add 0.0.0.0/0 via 1.1.1.2 metric 10 src 33.33.33.33
ip route add 0.0.0.0/0 via 2.2.2.2 metric 20 src 33.33.33.33**
然后在其网卡1直连的机器1上配置一条路由：
**route add -host 33.33.33.33 gw 1.1.1.1 (1.1.1.1是网卡1的IP地址)**
然后在其网卡2直连的机器2上配置一条路由：
**route add -host 33.33.33.33 gw 2.2.2.1 (2.2.2.1是网卡2的IP地址)**

> 这就是 递归路由了趴~~

效果是什么？效果就是网卡1或者网卡2由于某种原因down掉了，只要另一个还up，33.33.33.33这个地址就是可达的，同时33.33.33.33也是提供服务的地址。在这个例子中，网卡上配置的1.1.1.1，2.2.2.1这两个IP地址完全是用于IP路由寻址的，而标示主机的33.33.33.33则配置在Loopback接口上。Loopback接口的IP地址被认为只能是最后一跳，因为不能将它用于寻址。


#### 路由器 loopback端口

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。

如果loopback接口存在、有IP地址，在路由协议中就会将其用作Router ID，这样比较稳定--loopback接口一直都是up的。
如果loopback接口不存在、或者没有IP地址，Router ID就是最高的IP地址，这样就比较危险--只要是物理地址就有可能down掉。
对于CISCO来说，Router ID是不能配置的，对于VRP来说，Router ID可以配置，那麽我们也可以将Loopback接口地址配成Router ID。、

数据包发出时的源地址选择上，按照IP路由逻辑，在没有bind地址的情况下，源地址选择将和下一跳网关执行最长掩码匹配算法来选择。我们不能指望上层都会bind源地址，因此就需要在IP层影响源地址选择算法，否则Loopback接口的地址将永远不会被选中，因为它没有链路层路由，和任何地址都不处在“同一网段”，故而你不能在“该网段”去寻找下一跳。



Loopback接口是虚拟接口，是一种纯软件性质的虚拟接口。任何送到该接口的网络数据报文都会被认为是送往设备自身的。大多数平台都支持使用这种接口来模拟真正的接口。这样做的好处是虚拟接口不会像物理接口那样因为各种因素的影响而导致接口被关闭。事实上，将Loopback接口和其他物理接口相比较，可以发现Loopback接口有以下几条优点：
  1.Loopback接口状态永远是up的，即使没有配置地址。这是它的一个非常重要的特性。
  2.Loopback接口可以配置地址，而且可以配置全1的掩码,可以节省宝贵的地址空间。
  3.Loopback接口不能封装任何链路层协议。

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。对于CISCO路由器来说，可以配置[no] ip unreachable命令，来设置是[否]发送icmp不可达报文，对于VRP来说，没有这条命令，缺省不发送icmp不可达报文 。

**基于以上所述**，决定了Loopback接口可以广泛应用在各个方面。其中最主要的应用就是：路由器使用loopback接口地址作为该路由器产生的所有IP包的源地址，这样使过滤通信量变得非常简单。

1.在Router ID中的应用
如果loopback接口存在、有IP地址，在路由协议中就会将其用作Router ID，这样比较稳定--loopback接口一直都是up的。
如果loopback接口不存在、或者没有IP地址，Router ID就是最高的IP地址，这样就比较危险--只要是物理地址就有可能down掉。
对于CISCO来说，Router ID是不能配置的，对于VRP来说，Router ID可以配置，那麽我们也可以将Loopback接口地址配成Router ID。

##### 配置BGP loopback

在IBGP配置中使用loopback接口，可以使会话一直进行，即使通往外部的接口关闭了也不会停止。配置举例：
interface loopback 0
ip address 215.17.1.34 255.255.255.255
router bgp 200
neighbor 215.17.1.35 remote-as 200
neighbor update-source loopback 0





### 引用

1. https://zhuanlan.zhihu.com/p/398162417
2. https://blog.csdn.net/qq_29229567/article/details/97813141
3. http://www.mryu.top/notes/311.html
