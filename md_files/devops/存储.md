## 存储

### 大家交流的术语...

FC存储: FC在虚拟机场景下根本行不通。

FC-SAN成本搞不容易扩展，单点故障等问题。考虑成本的话iscsi和nfs就好了，FC-SAN太贵



IP存储: 即iscsi存储



### SAN

存储区域网络 (Storage Area Network, SAN) 是企业最常用的存储网络架构，要求高吞吐量和低延迟的业务关键型应用往往采用这类架构运行

#### SAN协议

* 光纤通道协议 (FCP)
* Internet 小型计算机系统接口 (iSCSI)
* 以太网光纤通道 (FCoE)
* 基于光纤通道的非易失性内存标准 (FC-NVMe)

#### FC-SAN： scsi

通常SAN由磁盘阵列（RAID）连接光纤通道（Fibre Channel）组成（为了区别于IP SAN，通常SAN也称为FC-SAN）。SAN和服务器和客户机的数据通信通过SCSI命令而非TCP/IP，数据处理是“块级”（block level）。SAN也可以定义为是以数据存储为中心，它采用可伸缩的网络拓扑结构，通过具有高传输速率的光通道的直接连接方式，提供SAN内部任意节点之间的多路可选择的数据交换，并且将数据存储管理集中在相对独立的存储区域网内。

#### IP-SAN：iscsi

IP-SAN（IP存储）的通信通道是使用IP通道，而不是光纤通道，把服务器与存储设备连接起来的技术，除了标准已获通过的iSCSI，还有FCIP、iFCP等正在制定的标准。

iSCSI 网络存储,在工作上分为服务端(target)和客户端(initiator).iSCSI服务端用于存放硬盘存储资源的服务器,能够为用户提供可用的存储资源,iSCSI客户端则是用户使用的软件,用于访问远程服务端的存储资源.



### NAS

#### NAS 协议

* **公共 Internet 文件服务/服务器消息块 (Common Internet File Services / Server Message Block, CIFS/SMB)。**这是 Windows 通常使用的协议。

* **网络文件系统 (NFS)。**NFS 最早为 UNIX 服务器而开发，也是通用的 Linux 协议。

### iscsi协议的意义...???

ip存储的热潮，iscsi一枝独秀--

相比fc技术而言，昂贵的fc交换变成了成本低廉的以太网交换，价格不菲的fc适配器换成了主板集成的以太网端口。

iscsi技术的基础——以太网和tcp/ip是充分成熟的技术

看：https://blog.csdn.net/qq776306395/article/details/30482621

所有数据在没有文件系统格式化的情况下，都以块的形式存储于磁盘之上。并行SCSI将数据以块的形式传送至存储，但是，对于网络它的用处相当有限，因为线缆不能超过25米，而且最多只能连接16个设备。

光纤通道是目前SAN的主导架构，它在专门的高速网络上分离存储资源。光纤通道协议与互联技术起源于满足高性能传送块数据的需求，同时克服直连存储的连接和距离限制。通常光纤通道设备连接距离可达到10000米，甚至数十万米，并且对于连接在SAN之上的设备没有数量要求。

> 但是造价太贵了--

iSCSI是一种使用TCP/IP协议，在现有IP网络上传输SCSI块命令的工业标准，它是一种在现有的IP网络上无需安装单独的光纤网络即可同时传输消息和块数据的突破性技术。iSCSI基于应用非常广泛的TCP/IP协议，将SCSI命令/数据块封装为iSCSI包，再封装至TCP 报文，然后封装到IP 报文中。iSCSI通过TCP面向连接的协议来保护数据块的可靠交付。由于iSCSI基于IP协议栈，因此可以在标准以太网设备上通过路由或交换机来传输。

https://blog.51cto.com/xslwahaha/1617781

为什么不直接使用ceph rbd要使用iscsi？？？



iSCSI SAN组件与FC SAN组件相类似。包括以下部件：

 

**iSCSI Client/Host**：

 

系统中的iSCSI客户端或主机（也称为iSCSI initiator），诸如服务器，连接在IP网络并对iSCSI target发起请求以及接收响应。每一个iSCSI主机通过唯一的IQN来识别，类似于光纤通道的WWN。

 

要在IP网络上传递SCSI块命令，必须在iSCSI主机上安装iSCSI驱动。推荐通过GE适配器（每秒1000 megabits）连接至iSCSI target。如同标准10/100适配器，大多数Gigabit适配器使用Category 5 或Category 6E线缆。适配器上的各端口通过唯一的IP地址来识别。

**iSCSI Target：**

 

iSCSI target是接收iSCSI命令的设备。此设备可以是终端节点，如存储设备，或是中间设备，如IP和光纤设备之间的连接桥。

每一个iSCSI target通过唯一的IQN来标识，存储阵列控制器上（或桥接器上）的各端口通过一个或多个IP地址来标识。

**本机与异构IP SAN：**

iSCSI initiator与iSCSI target之间的关系如图1所示。

本例中，iSCSI initiator(或client)是主机服务器，而iSCSI target是存储阵列。

此拓扑称为本机iSCSI SAN,它包含在TCP/IP上传输SCSI协议的整个组件。

与之相反，**异构IP SAN，**如下图所示，包含在TCP/IP与光纤交换结构传输SCSI的组件。

为了实现这一点，需要在IP与光纤通道之间安装连接桥或网关设备。连接桥用于TCP/IP与光纤通道之间的协议转换。

因此iSCSI主机将存储看做iSCSI target。

直接连接光纤通道target的服务器必须包含HBA而不是iSCSI主机的网络适配卡。

iSCSI主机可使用NIC或HBA。

### iscsi and NFS

NFS 是以文件为单位的，共享出去的是文件
ISCSI是以block为单位，共享出去的是设备，端口：3260/tcp

### CEPH 对标的应该是存储阵列？？？

0.0 好像真的是这样

iscsi是个通用的协议

### iscsi and ceph RBD

https://www.suse.com/c/rbd-vs-iscsi-how-best-to-connect-your-hosts-to-a-ceph-cluster/

ceph 集群目前支持三种形式的存储接口：文件、对象、块，其中块接口（即 RBD）与 SCSI 块设备读写所要求的接口一致，因此可以基于 ceph 的 RBD 提供 SCSI 存储系统后端，当然如果有足够信心的话也可以完全抛弃 ceph 提供的这三种基础接口，而在原始的 RADOS 接口上开发新的块接口，当然除非原始的 RBD 接口有重要缺陷，否则暂时还看不到重新发明轮子的必要，注意后文的讨论都将基于这一基本假设。

**基于 RBD 的 iSCSI 支持有多种实现思路，目前考虑到的有如下三类，概**述如下：

1. 为 iSCSI 客户端增加 RBD 客户端的功能，即在客户端实现 iSCSI initiator 与 RBD client 的融合；
2. 类似于 MDS 的实现，为 ceph 集群增加 LUS(Logical Unit Server) 服务器，由 LUS 负责 iSCSI 业务接入；
3. 选择合适的 iSCSI target 为其增加 RBD 后端支持，并在终端用户与 ceph 集群之间架设 iSCSI 网关（可以扩展成其它类型的如 FC 网关）；



iscsi缺点

I/O端的速度限制：Brocade指出在Host主机及Target存储设备两处的I/O端速度一直不上来，所以即使10Gb以太网络真的普及，I/O端的速度瓶颈仍然会拖跨这个传输效能。

软件iSCSI Initiator效能不佳：其乃透过软件仿真来执行SCSI指令，所以会耗费掉大量的CPU资源，造成整体效能的低落。

无法兼顾效能及跨平台性：iSCSI Initiator可分为三种，亦即软件Initiator驱动程序、硬件的TOE HBA卡及iSCSI HBA卡。就效能而言，Initiator驱动程序最差、TOE居中、iSCSI HBA卡最佳。但是iSCSI HBA只能走iSCSI协议，而无法透过NFS(Network File System，SUN制定)或CIFS(Common Internet File System，微软制定)等档案系统协议与应用服务器沟通。但Initiator驱动程序及TOE则同时支持iSCSI、NFS及CIFS三种协议。



iSCSI技术是一种由IBM公司研究开发的，是一个供硬件设备使用的可以在IP协议的上层运行的SCSI指令集，这种指令集合可以实现在IP网络上运行SCSI协议，使其能够在诸如高速千兆以太网上进行路由选择。iSCSI技术是一种新储存技术，该技术是将现有SCSI接口与以太网络(Ethernet)技术结合，使服务器可与使用IP网络的储存装置互相交换资料。

ISCSI使用rbd作为后端存储。ISCSI角色分为**target**和**initiator**

**target**端即磁盘阵列或其他装有磁盘的主机，通过iscsi target工具将磁盘空间映射到网络上，**initiator**端就可以寻找发现并使用该磁盘。

**initiator**作为ISCSI的使用者，发送SCSI命令，用于寻找发现网络上的**target**，并使用网络上的磁盘。

#### ceph iscsi gateway

The iSCSI Gateway presents a Highly Available (HA) iSCSI target that exports RADOS Block Device (RBD) images as SCSI disks. The iSCSI protocol allows clients (initiators) to send SCSI commands to storage devices (targets) over a TCP/IP network, enabling clients without native Ceph client support to access Ceph block storage. These include Microsoft Windows and even BIOS.





### 引用

1. https://blog.51cto.com/dcx86team/904499
2. https://www.jianshu.com/p/82eee3b3010c