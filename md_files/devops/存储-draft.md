## 存储、

### 交换机

交换机互联IP 和 交换机

### 看lun id 

lsblk + ll /dev/disk

### iscsi报错

错误原因：

基于iscsi协议挂载了 lun ID为 12 和 15 的块设备，然后由于块设备资源池不够，导致删除了 lun ID 12 和 15的块设备，调整块设备的资源分配，重新创建了3个块设备。但是 cloudos node没有自动卸载掉已挂载的iscsi device，导致lun id 12和15 被删除后，node还保留这挂载，导致cloudos plat读取lun 12和15块设备时出错。

解决办法：

根据报错日志，一个个删除掉 iscsi device

```bash
[INFO ] 15:16:30.912 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - command is :/lib/udev/scsi_id  -g  -u /dev/sdq
[INFO ] 15:16:31.020 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - exec cmd result is:
[INFO ] 15:16:31.020 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - exec cmd exitCode is:1

[INFO ] 14:50:28.867 [ForkJoinPool.commonPool-worker-2] c.h.c.c.s.service.PvServiceImpl - capacity: 2147483648
[INFO ] 14:50:28.867 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - command is :/lib/udev/scsi_id  -g  -u /dev/sdcj
[INFO ] 14:50:28.931 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - exec cmd result is:
[INFO ] 14:50:28.931 [ForkJoinPool.commonPool-worker-2] c.h.c.c.storage.utils.SshUtils - exec cmd exitCode is:1
[INFO ] 14:50:28.931 [ForkJoinPool.commonPool-worker-2] c.h.c.c.s.service.PvServiceImpl - query device blkid: /lib/udev/scsi_id  -g  -u /dev/sdcj error!
[INFO ] 14:50:28.931 [http-nio-8080-exec-10] c.h.c.c.s.service.PvServiceImpl - original iscsi info: [DaemonResponseVo{id='null', status=false, errorCode='null', operType=null, groupUuid='null', message='null', data=null, code='null', list=null, iscsiIqnDeviceEntityList=null, ip='null'}]
[INFO ] 14:50:28.931 [http-nio-8080-exec-10] c.h.c.c.s.service.PvServiceImpl - transferIscsiDevice: iscsi device not exist.
[INFO ] 14:50:28.931 [http-nio-8080-exec-10] c.h.c.c.s.service.PvServiceImpl - getTarget: after transferIscsiDevice, iscsi device is empty.
[ERROR] 14:50:28.931 [http-nio-8080-exec-10] c.h.c.c.s.controller.PvController - 获取iscsi target失败：无可用的iqn和lun

## 日志中的错误命令
[root@cloudos2-node1 ~]# ll /dev/disk/by-path/ | grep sdcj
lrwxrwxrwx. 1 root root 10 Mar 19 11:14 ip-172.200.20.11:3260-iscsi-iqn.2018-01.com.h3c.onestor:4dee75064df6429f8a163074f4995859-lun-15 -> ../../sdcj
[root@cloudos2-node1 ~]# /lib/udev/scsi_id  -g  -u /dev/sdcj
[root@cloudos2-node1 ~]# echo $?
1

## 删之前稳一点lsblk确认下是否真的不存在了
[root@cloudos2-node1 ~]# lscsi|grep sdcm
[root@cloudos2-node1 ~]# lsscsi |grep sdcm
[9:0:0:15]   disk    IET      VIRTUAL-DISK     0001  /dev/sdcm
[root@cloudos2-node1 ~]#
echo "1" > /sys/class/scsi_device/8\:0\:0\:15/device/delete
```

使用命令`echo 1 > /sys/block/device-name/device/delete`删除磁盘，device-name以sd开头，比如sda、sdb；或者使用命令`echo 1 > /sys/class/scsi_device/h:c:t:l/device/delete`删除磁盘，h代表HBA卡号，c代表HBA卡channel，t代表SCSI target ID，i代表LUN ID。h:c:t:l这些信息可以通过`lsscsi`、`/lib/udev/scsi_id`，`multipath –l`，`ls –l  /dev/disk/by-*`方式查看。



### 操作：网络

1。先部署uis集群，并已bridge桥接模式创建三个vm
2。基于3个vm部署cloudos，但是是管理网络
3。业务网和管理网不同vlan
问题
车站通过管理网被中心那管
中心给车站uis下发虚拟机时能保证网络是业务网？
确定下sna创建的网段
云平台上创建的经典网络对应的时哪个网段？！
虚拟网vxlan最终要转成底层underlay vlan传输

3.3.3.3的IP

难点：

1. 我怎么快速定位是因为node连不上存储外网IP呢
2. 我怎么快速在交换机上定位port配置问题呢
3. 我怎么快速对比计划配置和现存配置的区别呢



现象：一个机器上rbd全部down了

定位：cvk-node-5节点ping 存储外网失败，然后断定是网卡问题

查看交换机配置表：

| XG1/0/17 | cvknode5-slot1-port1（eth6） | Trunk | 110-120 | 11   |
| -------- | ---------------------------- | ----- | ------- | ---- |
| XG1/0/20 | cvknode5-slot3-port1（eth0） | Trunk | 110-120 | 11   |

连上交换机查看交换机bound是否端口聚合是否出错

果然：发现本来该是port 20 和 port 17聚合的，结果是port 16 和 port 27了



### raid and cc

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/raid1-and-cc.jpg)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/raid2-and-cc.jpg)



### 大家交流的术语...

FC存储: FC在虚拟机场景下根本行不通。

FC-SAN成本搞不容易扩展，单点故障等问题。考虑成本的话iscsi和nfs就好了，FC-SAN太贵



IP存储: 即iscsi存储

配置机房网络连接

* 网线插上，仅配置ip+mask就行，不用指定网关

* cmd手动添加一条路由即可：

  route add 172.0.0.0(svc-net) mask 255.0.0.0 **10.145.102.254**(next hot)

### 无敌：

https://www.cnblogs.com/zxqstrong/p/4727912.html

### DAS and NAS and SAN

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DAS-and-NAS-and-SAN.png)



### storage networks

 针对I/O是整个网络系统效率低下的瓶颈问题，专家们提出了许多种解决办法。

 其中抓住症结并经过实践检验为最有效的办法是：**将数据从通用的应用服务器中分离出来以简化存储管理。**



![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/storage-networks.jpg)

由图可知原来存在的问题：每个新的应用服务器都要有它自己的存储器。这样造成数据处理复杂，随着应用服务器的不断增加，网络系统效率会急剧下降。解决方案

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/storage-networks-2.jpg)

从图可看出：将存储器从应用服务器中分离出来，进行集中管理。这就是所说的存储网络（Storage Networks）。 

**使用存储网络的好处**：

* 统一性：形散神不散，在逻辑上是完全一体的。 
* 实现数据集中管理，因为它们才是企业真正的命脉。 
* 容易扩充，即收缩性很强。 
* 具有容错功能，整个网络无单点故障。 

专家们针对这一办法又采取了两种不同的实现手段，即NAS（Network Attached Storage）网络接入存储和SAN(Storage Area Networks)存储区域网络。

* NAS：用户通过TCP/IP协议访问数据，采用业界标准文件共享协议如：NFS、HTTP、CIFS实现共享。 
* SAN：通过专用光纤通道交换机访问数据，采用SCSI、FC-AL接口。

### SAN

存储区域网络 (Storage Area Network, SAN) 是企业最常用的存储网络架构，要求高吞吐量和低延迟的业务关键型应用往往采用这类架构运行。

SAN（存储区域网络）采用光纤通道（Fibre Channel ，简称FC）技术，通过光纤通道交换机连接存储阵列和服务器主机，建立专用于数据存储的区域网络。SAN经过十多年历史的发展，已经相当成熟，成为业界的事实标准（但各个厂商的光纤交换技术不完全相同，其服务器和SAN存储有兼容性的要求）。**SAN解决方案是从基本功能剥离出存储功能，所以运行备份操作就无需考虑它们对网络总体性能的影响。**

#### SAN协议

* 光纤通道协议 (FCP)
* Internet 小型计算机系统接口 (iSCSI)
* 以太网光纤通道 (FCoE)
* 基于光纤通道的非易失性内存标准 (FC-NVMe)
* #

#### SCSI-2 and SCSI-3

 SCSI协议的主要功能是在主机和存储设备之间传送命令、状态和块数据。在各类存储技术中，SCSI协议可谓是最重要的脊梁。

小型计算机系统接口（英语：Small Computer System Interface; 简写：SCSI），一种用于计算机和智能设备之间（硬盘、软驱、光驱、打印机、扫描仪等）系统级接口的独立处理器标准

SCSI-2具体基本访问控制能力，但是无法满足Active/Active多路径环境和集群多节点访问存储的需求。SCSI-3通过引入客户端注册和操作权限分类概念，强化并行访问权限控制，弥补SCSI-2的不足。

#### iSCSI

http://www.linkwan.com/gb/tech/htm/1282.htm

The Internet Small Computer Systems Interface (iSCSI) protocol 

iSCSI：SCSI与TCP/IP结合，把SCSI命令和数据用IP包封装起来，事实上ISCSI作为传输层的东西。

iSCSI是将SCSI命令在封装在TCP/IP包里面，并使用一个iSCSI帧头；封装SCSI数据包成为iSCSI需要大量消耗处理器资源。然而，iSCSI的基于TCP/IP的操作也同样有一个巨大优势，易于路由，不必特殊硬件即可实现，这也是FCoE一直应用于数据中心的一个重要原因。

iSCSI的三种连接方式



IP-SAN根据主机与存储的连接方式不同,可以分为三种:



1、以太网卡 + initiator软件  

2、硬件TOE网卡+ initiator软件  

3、 iSCSI HBA卡



- 以太网卡 + initiator软件：主机使用标准的以太网卡(NIC)与网络进行连接。iSCSI 和TCP/IP协议栈功能通过主机CPU进行处理。这种方式直接使用传统主机系 统通用的NIC卡,所以成本最低,但是由于需要占用CPU资源进行iSCSI协议和 TCP/IP协议处理,所以会导致主机系统性能的下降。



- 硬件TOE网卡+ initiator软件：主机使用TOE(TCP offload Engine,TCP卸载引擎)网卡 ,iSCSI协议的功能仍然由主机的CPU完成,但是TCP协议处理则交由TOE网卡完成,从而有效减轻了主机CPU的负担



- iSCSIHBA卡：采用这种方式的主机,其iSCSI和TCP/IP协议功能均由iSCSI HBA卡完成,对主机的开销占用最小。

  

#### FC-SAN： scsi

通常SAN由磁盘阵列（RAID）连接光纤通道（Fibre Channel）组成（为了区别于IP SAN，通常SAN也称为FC-SAN）。SAN和服务器和客户机的数据通信通过SCSI命令而非TCP/IP，数据处理是“块级”（block level）。SAN也可以定义为是以数据存储为中心，它采用可伸缩的网络拓扑结构，通过具有高传输速率的光通道的直接连接方式，提供SAN内部任意节点之间的多路可选择的数据交换，并且将数据存储管理集中在相对独立的存储区域网内。

#### IP-SAN：iscsi

IP-SAN（IP存储）的通信通道是使用IP通道，而不是光纤通道，把服务器与存储设备连接起来的技术，除了标准已获通过的iSCSI，还有FCIP、iFCP等正在制定的标准。

iSCSI 网络存储,在工作上分为服务端(target)和客户端(initiator).iSCSI服务端用于存放硬盘存储资源的服务器,能够为用户提供可用的存储资源,iSCSI客户端则是用户使用的软件,用于访问远程服务端的存储资源.



### NAS

NAS（Network Attached Storage—网络附加存储），即将存储设备通过标准的网络拓扑结构（例如以太网），连接到一群计算机上。NAS是部件级的存储方法，它的重点在于帮助工作组和部门级机构解决迅速增加存储容量的需求。需要共享文件的工程小组就是典型的例子。

**NAS没有解决与文件服务器相关的一个关键性问题，即备份过程中的带宽消耗。**与将备份数据流从LAN中转移出去的存储区域网（SAN）不同（存储内网实现备份即存储的东西流量？），NAS仍使用网络进行备份和恢复。NAS 的一个缺点是它将存储事务由并行SCSI连接转移到了网络上。这就是说LAN除了必须处理正常的最终用户传输流外，还必须处理包括备份操作的存储磁盘请求。



#### NAS 协议

* **公共 Internet 文件服务/服务器消息块 (Common Internet File Services / Server Message Block, CIFS/SMB)。**这是 Windows 通常使用的协议。
* **网络文件系统 (NFS)。**NFS 最早为 UNIX 服务器而开发，也是通用的 Linux 协议。



### scsi协议

https://www.modb.pro/db/98228

小型计算机系统接口（英语：Small Computer System Interface; 简写：SCSI），一种用于计算机和智能设备之间（硬盘、软驱、光驱、打印机、扫描仪等）系统级接口的独立处理器标准。

 SCSI协议的主要功能是在主机和存储设备之间传送命令、状态和块数据。在各类存储技术中，SCSI协议可谓是最重要的脊梁。

FCP-SCSI：是将SCSI并行接口转化为串行接口方式的协议，应用于存储系统和服务器之间的数据传输。新的ANSI T10 标准，支持SAN 上存储系统之间通过数据迁移应用来直接移动数据。 FCP-SCSI 提供200MB/s（全双工独占带宽）的传输速率，每连接最远达10 公里，最大16000000 个节点。FCP-SCSI 使用帧传输取代块传输。帧传输以×××传输方式传输短的小的事务数据。

### iscsi协议

https://developer.aliyun.com/article/256450

https://blog.csdn.net/nirendao/article/details/82928761



iSCSI 技术有以下三个革命性的改变：

 (1) 把原来只用于本机的 SCSI 协议透过 TCP/IP 网络发送，使连接距离可作无限的区域延伸。 

(2) 连接的服务器数量无线 (原来的 SCSI-3 的上限是 15) 

(3) 由于是服务器架构，因此也可以实现在线扩容已致动态部署。

功能： iSCSI 利用了 TCP/IP 的 port 860 和 3260 作为沟通的渠道，透过两台计算机之间利用 iSCSI 的协议来交换 SCSI 命令，让计算机可以透过高速的局域网集线来把 SAN 模拟成为本地的存储装置。 

本质上，iSCSI 让两个主机通过 IP 网络相互协商然后交换 SCSI 命令，这样一来，ISCSI 就是用广域网仿真了一个常用的高性能本地存储总线，从而创建了一个存储局域网 (SAN)，不像某些 SAN 协议，iSCSI 不需要专用的电缆，它可以在已有的交换和 IP 基础架构上运行，然而，如果不使用专用的网络或者子网 (LAN 或者 VLAN)，iSCSI SAN 的部署性能可能会严重下降，于是，iSCSI 尝尝被认为是光纤通道的一个低成本替代方法，光纤通道是需要专用的基础架构，但是，基于以太网的光纤通道则不需要专用的基础架构

**iSCSI是一种使用TCP/IP协议，在现有IP网络上传输SCSI块命令的工业标准**，它是一种在现有的IP网络上无需安装单独的光纤网络即可同时传输消息和块数据的突破性技术。iSCSI基于应用非常广泛的TCP/IP协议，将SCSI命令/数据块封装为iSCSI包，再封装至TCP 报文，然后封装到

　　iSCSI架构依然遵循典型的SCSI模式：

　　　　随着光纤通道的发明，initiator和target之间的SCSI线缆已被光纤线缆所代替。

　　　　现在随着iSCSI的出现光纤线缆又被价格低廉的网线和TCP/IP网络所替代。



　　iSCSI SAN组件与FC SAN组件相类似。包括以下部件：

　　　　**iSCSI Client/Host**：

　　　     系统中的iSCSI客户端或主机（也称为iSCSI initiator），诸如服务器，连接在IP网络并对iSCSI target发起请求以及接收响应。每一个iSCSI主机通过唯一的IQN来识别，类似于光纤通道的WWN。

　　　　要在IP网络上传递SCSI块命令，必须在iSCSI主机上安装iSCSI驱动。推荐通过GE适配器（每秒1000 megabits）连接至iSCSI target。如同标准10/100适配器，大多数Gigabit适配器使用Category 5 或Category 6E线缆。适配器上的各端口通过唯一的IP地址来识别。

　　　　**iSCSI Target：**

　　　　　　iSCSI target是接收iSCSI命令的设备。此设备可以是终端节点，如存储设备，或是中间设备，如IP和光纤设备之间的连接桥。每一个iSCSI target通过唯一的IQN来标识，存储阵列控制器上（或桥接器上）的各端口通过一个或多个IP地址来标识。

### WHY ISCSI

https://www.szsandstone.com/technical/article/42.html

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/why iscsi.jpg)

CEPH提供了对象、块、CEPHFS，块接口主要通过librbd或者KRBD支持，librbd是应用态接口，普通应用不能直接使用，krbd只能部署在linux高内核版本系统。但是企业环境里面常用到的VMWare EXSi、Windows/Solaris操作系统是无法直接使用librbd，而krbd也无法运行在这些系统中。所以一个标准的iSCSI接口就成为这些系统使用CEPH的最优方案。

#### 企业级ceph实践

重新编写了新的iSCSI Target，模块名称为STGT。STGT实现了分布式锁机制，从而解决了多个Active target之间支持release/reserve和 Persistent Reservation的问题。同时，将LUN映射信息存储在RADOS集群中，同时在STGT中缓存所有的元数据以加快访问速度。
当LUN映射信息发生变更时，会通知所有STGT的缓存进行变更。
其次，在性能方面，我们通过多线程池提高IO的并发度。

再次，由于是重新开发的软件栈，STGT网络接收到iSCSI数据时，就是用buffer_list保存数据，之后不再需要任何拷贝就通过librados发送给OSD了，从而避免了两个不同开源模块之间的内存拷贝。优化后，单个STGT我们相对于开源TGT的性能，在并发IO下提升超过10倍的性能。


### iscsi协议的意义...???

https://blog.csdn.net/nirendao/article/details/82928761



ip存储的热潮，iscsi一枝独秀--

相比fc技术而言，昂贵的fc交换变成了成本低廉的以太网交换，价格不菲的fc适配器换成了主板集成的以太网端口。

iscsi技术的基础——以太网和tcp/ip是充分成熟的技术

看：https://blog.csdn.net/qq776306395/article/details/30482621

所有数据在没有文件系统格式化的情况下，都以块的形式存储于磁盘之上。并行SCSI将数据以块的形式传送至存储，但是，对于网络它的用处相当有限，因为线缆不能超过25米，而且最多只能连接16个设备。

光纤通道是目前SAN的主导架构，它在专门的高速网络上分离存储资源。光纤通道协议与互联技术起源于满足高性能传送块数据的需求，同时克服直连存储的连接和距离限制。通常光纤通道设备连接距离可达到10000米，甚至数十万米，并且对于连接在SAN之上的设备没有数量要求。

> 但是造价太贵了--

iSCSI是一种使用TCP/IP协议，在现有IP网络上传输SCSI块命令的工业标准，它是一种在现有的IP网络上无需安装单独的光纤网络即可同时传输消息和块数据的突破性技术。iSCSI基于应用非常广泛的TCP/IP协议，将SCSI命令/数据块封装为iSCSI包，再封装至TCP 报文，然后封装到IP 报文中。iSCSI通过TCP面向连接的协议来保护数据块的可靠交付。由于iSCSI基于IP协议栈，因此可以在标准以太网设备上通过路由或交换机来传输。

https://blog.51cto.com/xslwahaha/1617781

为什么不直接使用ceph rbd要使用iscsi？？？



iSCSI SAN组件与FC SAN组件相类似。包括以下部件：

 

**iSCSI Client/Host**：

 

系统中的iSCSI客户端或主机（也称为iSCSI initiator），诸如服务器，连接在IP网络并对iSCSI target发起请求以及接收响应。每一个iSCSI主机通过唯一的IQN来识别，类似于光纤通道的WWN。

 

要在IP网络上传递SCSI块命令，必须在iSCSI主机上安装iSCSI驱动。推荐通过GE适配器（每秒1000 megabits）连接至iSCSI target。如同标准10/100适配器，大多数Gigabit适配器使用Category 5 或Category 6E线缆。适配器上的各端口通过唯一的IP地址来识别。

**iSCSI Target：**

 

iSCSI target是接收iSCSI命令的设备。此设备可以是终端节点，如存储设备，或是中间设备，如IP和光纤设备之间的连接桥。

每一个iSCSI target通过唯一的IQN来标识，存储阵列控制器上（或桥接器上）的各端口通过一个或多个IP地址来标识。

**本机与异构IP SAN：**

iSCSI initiator与iSCSI target之间的关系如图1所示。

本例中，iSCSI initiator(或client)是主机服务器，而iSCSI target是存储阵列。

此拓扑称为本机iSCSI SAN,它包含在TCP/IP上传输SCSI协议的整个组件。

与之相反，**异构IP SAN，**如下图所示，包含在TCP/IP与光纤交换结构传输SCSI的组件。

为了实现这一点，需要在IP与光纤通道之间安装连接桥或网关设备。连接桥用于TCP/IP与光纤通道之间的协议转换。

因此iSCSI主机将存储看做iSCSI target。

直接连接光纤通道target的服务器必须包含HBA而不是iSCSI主机的网络适配卡。

iSCSI主机可使用NIC或HBA。

### iscsi and NFS

NFS 是以文件为单位的，共享出去的是文件
ISCSI是以block为单位，共享出去的是设备，端口：3260/tcp

### CEPH 对标的应该是存储阵列？？？

0.0 好像真的是这样

iscsi是个通用的协议

### iscsi and ceph RBD

https://www.suse.com/c/rbd-vs-iscsi-how-best-to-connect-your-hosts-to-a-ceph-cluster/

ceph 集群目前支持三种形式的存储接口：文件、对象、块，其中块接口（即 RBD）与 SCSI 块设备读写所要求的接口一致，因此可以基于 ceph 的 RBD 提供 SCSI 存储系统后端，当然如果有足够信心的话也可以完全抛弃 ceph 提供的这三种基础接口，而在原始的 RADOS 接口上开发新的块接口，当然除非原始的 RBD 接口有重要缺陷，否则暂时还看不到重新发明轮子的必要，注意后文的讨论都将基于这一基本假设。

**基于 RBD 的 iSCSI 支持有多种实现思路，目前考虑到的有如下三类，概**述如下：

1. 为 iSCSI 客户端增加 RBD 客户端的功能，即在客户端实现 iSCSI initiator 与 RBD client 的融合；
2. 类似于 MDS 的实现，为 ceph 集群增加 LUS(Logical Unit Server) 服务器，由 LUS 负责 iSCSI 业务接入；
3. 选择合适的 iSCSI target 为其增加 RBD 后端支持，并在终端用户与 ceph 集群之间架设 iSCSI 网关（可以扩展成其它类型的如 FC 网关）；



iscsi缺点

I/O端的速度限制：Brocade指出在Host主机及Target存储设备两处的I/O端速度一直不上来，所以即使10Gb以太网络真的普及，I/O端的速度瓶颈仍然会拖跨这个传输效能。

软件iSCSI Initiator效能不佳：其乃透过软件仿真来执行SCSI指令，所以会耗费掉大量的CPU资源，造成整体效能的低落。

无法兼顾效能及跨平台性：iSCSI Initiator可分为三种，亦即软件Initiator驱动程序、硬件的TOE HBA卡及iSCSI HBA卡。就效能而言，Initiator驱动程序最差、TOE居中、iSCSI HBA卡最佳。但是iSCSI HBA只能走iSCSI协议，而无法透过NFS(Network File System，SUN制定)或CIFS(Common Internet File System，微软制定)等档案系统协议与应用服务器沟通。但Initiator驱动程序及TOE则同时支持iSCSI、NFS及CIFS三种协议。



iSCSI技术是一种由IBM公司研究开发的，是一个供硬件设备使用的可以在IP协议的上层运行的SCSI指令集，这种指令集合可以实现在IP网络上运行SCSI协议，使其能够在诸如高速千兆以太网上进行路由选择。iSCSI技术是一种新储存技术，该技术是将现有SCSI接口与以太网络(Ethernet)技术结合，使服务器可与使用IP网络的储存装置互相交换资料。

ISCSI使用rbd作为后端存储。ISCSI角色分为**target**和**initiator**

**target**端即磁盘阵列或其他装有磁盘的主机，通过iscsi target工具将磁盘空间映射到网络上，**initiator**端就可以寻找发现并使用该磁盘。

**initiator**作为ISCSI的使用者，发送SCSI命令，用于寻找发现网络上的**target**，并使用网络上的磁盘。

#### ceph iscsi gateway

The iSCSI Gateway presents a Highly Available (HA) iSCSI target that exports RADOS Block Device (RBD) images as SCSI disks. The iSCSI protocol allows clients (initiators) to send SCSI commands to storage devices (targets) over a TCP/IP network, enabling clients without native Ceph client support to access Ceph block storage. These include Microsoft Windows and even BIOS.



### SCSI 总线和协议

 

​    I/O 技术实现在计算机和存储设备之间的数据交换。实现从CPU 到存储系统的I/O通路的一个中间就是SCSI(Small Computer System Interface).

 

一. I/O 通路

​    在计算机中，一个或多个CPU 处理在CPU缓存或主存储器（RAM：Random Access Memory）中的数据。 CPU缓存或主存储器是非常快的器件，但是断电就不能保存，价钱也比较昂贵。 所以数据还需要放在存储设备上。

​    通常，数据从主存储器（RAM）通过系统总线，主机I/O 总线 和 I/O 总线移动到磁盘或者磁带等存储设备。

 

1.1 系统总线

​    在计算机的核心部分，系统总线保证数据在CPU和主存储器之间进行快速的传递。 系统总线必须使用非常高的时钟频率，使得它能够足够快的给CPU 提供数据。 该总线的实现采用在主电路板上印制导线的形式。 出于物理性能的原因，高的系统速度需要短的印制导线。 因此，系统总线应该尽可能的短一些，并且只能连接CPU和主存储器。

 

1.2 主机I/O 总线

​    在现在计算机中，为了释放CPU 的应用处理负担，人们把尽可能多的任务移到诸如图像处理器这样的特别的处理器中。 由于上述物理上的限制条件，这些器件不可以连接到系统总线。 因此大多数计算机都实现了称作主机I/O总线的第二个总线。 桥接芯片提供在系统总线和主机I/O总线之间的连接。 PCI（Peripheral Component Interconnection:外围互联设备）是当前最广泛使用的实现主机I/O 总线的技术。

 

1.3 I/O 总线

​    设备驱动器负责控制外围设备以及与外围设备的通信。针对存储设备的设备驱动器部分以软件形式存在，该软件由CPU处理。由于跟存储设备通信的部分设备驱动器几乎总是以固件的形式实现，该固件由特别的处理器（ASIC:Application Specific Integration Circuit）处理。 当前这些ASIC 有的集成到主电路板（如SCSI控制器），也有的通过附加的PCI卡连接到主板。 这些附加的卡通常被称作控制器。 存储设备通过主机总线适配器（HBA:Host Bus Adapter）或者通过在板上的控制器连接到服务器。 在控制器和外围设备之间的通信连接叫作I/O总线。

​    当前用户I/O 总线的最重要的技术是SCSI 和光纤通道。 SCSI 定义了一种总线，该总线能够连接16个设备（包括服务器和存储设备）。 在另一方面，光纤通道定义存储网络的不同拓扑结构，该存储网络可以连接数百万个设备（包括服务器和存储设备）。 作为替代光纤通道的其他选择，工业界正在使用TCP/IP 和以太网（IP存储）实现存储网络。 注意的是，这些新技术都是继续使用SCSI 协议在设备间通信。

 

 

二. 并行SCSI 总线

​    把磁盘和磁带设备连接到应用服务器或文件服务器，最常用的方法就是通过传统的 SCSI总线。尽管 SCSI主要是一个块协议，但这个术语也被用来指称运行该协议的并行线缆机制。

​    最初的 SCSI物理层传输介质是一种并行电缆，由 8根数据线和一些控制线构成。在每个发送时钟里传输 8 位数据，传输速率相对说来是比较高的；但是由于电气方面的问题，使得多数SCSI设备所允许的传输距离被限制在 15-25 m左右。随着时间的推移，SCSI 并行总线的性能一直在提高，并通过提供更多的数据通路 (例如采用 16 位数据线和32位数据线)和更快的时钟，得到了更大的带宽。

​    并行总线存在的一个问题是飘移现象。如果把一组并行的多位数据同时发出，每条数据线上的传输延迟会出现差异，导致各个位不会在精确的同一时间到达目的地。所谓飘移指的是一个时间窗口，所有的数据位在这段分布的时间内都能到达目的地。各个传输线上传输延迟的差别越大，飘移窗口也就越大。根据传输线理论，总线中每条线路的传输阻抗 (包括容抗和感抗)跟它所处的位置有关，因此，传输延迟是位线所处的物理位置的函数。对于给定长度的线缆，要想增加时钟频率，就必须减小飘移窗口，从而最小化线路间的传输延迟差。显然在高频条件下，电缆越长，飘移窗口越大。

​    SCSI 规范的第 1 个版本发布于 1986 年。自那时以来，它被广泛应用于服务器和高档 PC 中，其速率由最初的4 MBps发展到现在的 320 MBps，而且还在提高着。

​    作为一种介质，SCSI定义了一个并行总线，用于数据传输和通信控制。总线本身可以是印制导线的形式，也可以是一根电缆。外部 SCSI设备使用电缆以菊花链的形式连接到服务器上的控制器。在菊花链中，每个设备都跟其他设备串接。由于这个原因，外部 SCSI设备典型地都有两个 SCSI连接器，可以分别连接到链中的前一个设备和后一个设备。现在的一个 SCSI 总线可以连接多至 16个设备。其中包括1 个SCSI控制器和 15个存储装置。

 

2.1 SCSI 类型

SCSI有三个基本规范：

​    SCSI-1：SCSI-1是在1986年开发的原始规范，现已不再使用。它规定总线宽度为8位，时钟速度为5MHz。

​    SCSI-2：1994年采用，此规范包括通用指令集(CCS)——支持任何SCSI设备所必需的18个命令。在此规范中，可以选择将时钟速度提高一倍，达到10MHz (Fast)，将总线宽度增加为原来的两倍，即16位，将设备数增加为15个(Wide)，或者同时实现上述两种升级(Fast/Wide)。SCSI-2还增加了命令队列，允许设备存储命令，并从主机排列命令优先级。

​    SCSI-3：此规范于1995年正式出台，包括一系列较小范围的标准。涉及SCSI并行接口(SPI)的一组标准在SCSI-3中得到了继续发展，SPI是SCSI设备之间的通信方式。大多数SCSI-3规范都以Ultra开头，如Ultra for SPI规范、Ultra2 for SPI-2规范和Ultra3 for SPI-3规范。名称中的Fast和Wide的含义与SCSI-2中的一样。SCSI-3是当前正在使用的标准。

 

​    双倍总线速度、双倍时钟速度和SCSI-3规范的不同组合，产生了许多不同的SCSI规范。下表对几种不同规范进行了比较。很多较慢的规范已不再使用——在此列出仅作比较之用。

| 名称        | 规范        | 设备数量 | 总线宽度 | 总线速度 | Mbps    |
| ----------- | ----------- | -------- | -------- | -------- | ------- |
| 异步SCSI    | SCSI-1      | 8        | 8位      | 5MHz     | 4Mbps   |
| 同步SCSI    | SCSI-1      | 8        | 8位      | 5MHz     | 5Mbps   |
| Wide        | SCSI-2      | 16       | 16位     | 5MHz     | 10Mbps  |
| Fast        | SCSI-2      | 8        | 8位      | 10MHz    | 10Mbps  |
| Fast/Wide   | SCSI-2      | 16       | 16位     | 10MHz    | 20Mbps  |
| Ultra       | SCSI-3SPI   | 8        | 8位      | 20MHz    | 20Mbps  |
| Ultra/Wide  | SCSI-3SPI   | 8        | 16位     | 20MHz    | 40Mbps  |
| Ultra2      | SCSI-3SPI-2 | 8        | 8位      | 40MHz    | 40Mbps  |
| Ultra2/Wide | SCSI-3SPI-2 | 16       | 16位     | 40MHz    | 80Mbps  |
| Ultra3      | SCSI-3SPI-3 | 16       | 16位     | 40MHz    | 160Mbps |
| Ultra320    | SCSI-3SPI-4 | 16       | 16位     | 80MHz    | 320Mbps |

 

​    除了总线速度提高之外，Ultra320 SCSI还使用分组化数据传输，从而提高其效率。Ultra2也是最后一种具有“窄”（8位）总线宽度的规范。

 

​    所有这些SCSI类型都是并行的——数据通过总线同时传输，而不是一次传输一种数据。最新的SCSI类型称为串行连接SCSI(SAS：Serial Attached SCSI)，这种连接使用SCSI命令，但以串行方式传输数据。SAS使用点对点串行连接，以3.0千兆位每秒的速度传输数据，每个SAS端口可以支持多达128个设备或扩展设备。

 

2.2 SCSI的控制器、设备和电缆

​    SCSI控制器在SCSI总线上的所有其他设备和计算机之间进行协调。SCSI控制器也称为主机适配器，控制器既可以是插入可用插槽的卡，也可以内置在主板上。SCSI BIOS（Basic Input output System）也在控制器上。它是一个小型ROM或闪存芯片，包含访问和控制总线上的设备所需的软件。

​    每个SCSI设备都必须具有唯一的标识符(ID)才能正常工作。例如，如果总线能够支持16个设备，通过硬件或软件设置指定的设备ID的范围为0-15。SCSI 控制器本身必须使用其中一个ID，通常是最高的那一个，而将其他ID留给总线上的其他15个设备使用。

​    内部设备通过带状电缆连接到SCSI控制器。外部SCSI设备使用一条粗的圆形电缆，以菊花链形式连接到控制器（串行连接SCSI设备使用SATA电缆）。在菊花链中，每个设备都依次连接到下一个设备。因此，外部SCSI设备通常具有两个SCSI连接器——分别连接前后两个设备。

 

电缆本身通常由三层构成：

​    （1）内层：保护性最好的层，包含实际发送的数据。

​    （2）介质层：包含向设备发送控制命令的线路。

​    （2）外层：包含传输奇偶校验信息的线路，这些信息可确保数据的正确性。

 

​    不同SCSI标准使用不同的连接器，这些连接器通常不兼容，通常使用50、68或80针。SAS使用较小的SATA兼容连接器。

​    一旦总线上的全部设备安装完毕，而且分配了各自的ID，则总线的每一端都必须闭合。下面介绍如何执行这一操作。

 

2.3 终接器

​    如果SCSI总线保持开放状态，沿总线发送的电信号会反射回来，从而干扰设备和SCSI控制器之间的通信。解决方法是终结总线，用电阻电路闭合每一端。如果总线同时支持内部和外部设备，则必须终结每个系列的最后一个设备。

 

SCSI 终结的类型主要可分为两类：被动（无源）和主动（有源）。

（1）被动（无源）终结通常用于在标准时钟速度下运行、且设备到控制器的距离小于1米的SCSI系统。

（2）主动（有源）终结用于Fast SCSI系统，或设备到SCSI控制器的距离大于1米的系统。

 

​    SCSI还使用三种不同类型的总线信令，这也会影响终结。电脉冲以信令的方式在线路上发送。

​    （1）单端(SE：Single-ended)：控制器生成信号，并通过单条数据线将信号传送至总线上的所有设备。每个设备都会产生信号损失。因此，信号会很快开始衰减，由此SE SCSI的传输距离被限制为约3米以内。PC中普遍采用SE信令。

​    （2）高压差动(HVD：High-Voltage Differential)：HVD常用于服务器，它以串联方式发送信号，采用一条数据高压线和一条数据低压线。SCSI总线上的每个设备都有信号收发器。控制器与设备通信时，总线沿途的设备接收信号并转发信号，直至信号到达目标设备为止。这样，控制器和设备之间的允许距离可显著增加，可达25米。

​    （3）低压差动(LVD：Low-Voltage Differential)：LVD是HVD的同类技术，工作原理非常相似。两者之间的差异在于，LVD的收发器更小，并且内置于每个设备的SCSI适配器中。这使得LVD SCSI设备的价格更合理，并且LVD使用更少的电量就可以通信。缺点在于最大距离仅为HVD的一半——12米。

   HVD和LVD通常都使用被动终结器，即使设备和控制器之间的距离远大于1米也是如此。这是因为收发器可以确保信号足够强，能从总线的一端传输到另一端

三. SCSI 协议

​    在SNIA 共享存储模型中，SCSI 负责从上层接收请求并转发，或者从并行设备获取数据并转发。

​    例如：有一个应用程序向操作系统发出对磁盘设备的写请求。 在SCSI协议层，这个写请求被看成是特定数量的数据块以协议的形式传递到指定位置的命令。作为操作系统和存储设备之间的一个中介，SCSI 协议既不规定数据块如何组织，也不规定怎样把数据块放到磁盘上。 在SCSI把数据块发送到目的地时，目标方可能是单个物理磁盘，也可能是把数据块在多个物理盘上分条存放的RAID 控制器。 SCSI 协议的责任，就是在确认写操作已经正确完成后向操作系统报告成功，而不管在磁盘上物理存储是如何配置以及写操作是如何执行的。

 

3.1 SCSI 域

​    SCSI 设备是在一定的环境中运行的。 通常需要有多个SCSI设备才能形成这样的环境。 SCSI 设备间的运行环境也称为SCSI域。在这个域内，生成和发送SCSI命令和任务管理请求的SCSI端口称为SCSI发起方，接收和处理SCSI命令，根据请求执行任务管理的端口称为SCSI目标方。

​    SCSI 域的组成包括SCSI设备，设备内的SCSI 发起方和目标方以及提供数据交接的总线。 SCSI总线连接了挂在它上面的所有SCSI设备。我们可以把一个实际的SCSI应用系统抽象为一个SCSI域，域中有多个SCSI设备，而且带SCSI驱动器的计算机也可以被看成是一个SCSI设备。

​    尽管可以允许有多个SCSI设备接在同一条总线上，SCSI协议实际定义的是设备间一对一的数据交换，即同一时刻在SCSI总线上只允许有两个设备互相交换数据。因为，SCSI上的各个设备是以分时共享的方式使用总线的。

​    在一个实际的SCSI域中，必须至少有一个发起方和1个目标方，考虑到主机对数据存储的需求，配置了SCSI控制器的主机至少有1个SCSI发起方。而磁盘设备主要是提供存储和数据服务，一般都有目标发。

   

3.2 SCSI 协议模型

​    为了便于实现和理解SCSI的各个协议，SCSI 采取了分层结构。 SCSI 大致可分为三层，即SCSI应用层，SCSI 传输层和SCSI 互连层。 SCSI中的各个具体协议一般都位于其中的某一层，可以可能跨越两层。

​    在应用层，SCSI 体系结构把发起方（主机）和目标方（如磁盘）的通信定义为客户/服务器交换。SCSI 客户位于主机中，代表上层应用程序，文件系统和操作系统I/O请求。 SCSI 设备服务器位于目标设备中，对请求做出响应。 客户/服务器请求和响应通过某种形式的底层协议进行传输。

​    在传输协议层，SCSI 设备之间通过一系列的命令实现数据的传送，大致分成三个阶段：命令的执行，数据的传送和命令的确认。

​    SCSI 互联层完成SCSI设备对总线的连接以及发送方和目标方的选择等功能。

 

3.3 寻址机制

​    为了对连接在总线上的设备寻址，SCSI 协议引入了SCSI设备ID 和逻辑单元号LUN. 在SCSI 总线上的每个设备都必须有一个唯一的ID，其中包括服务器中的主机总线适配器也拥有设备ID. 取决域SCSI标准的版本，每条总线最多可允许有8个或者16个设备ID。

​    诸如RAID 磁盘子系统和磁带库这样的存储设备可能包括若干个子设备，如虚拟磁盘，磁带驱动器和介质更换器等。 因此SCSI 引入了逻辑单元号，以便于对大的设备中的子设备进行寻址。 另外一个服务器可能配置了多个SCSI控制器，从而就可能有多条SCSI总线。 因此，操作系统用一个三元描述标识一个SCSI目标： 总线/目标设备/逻辑单元号

​    传统的SCSI 适配卡连接单个总线，相应的只具有一个总线号。 在引入存储网络之后，每个光纤通道HBA（Host Bus Adapter）或iSCSI（Internet SCSI）网卡也都连接一条总线，分配一个总线号，在他们之间依靠不同的总线号加以区分。

​    目标设备标识在一条总线菊花链上的单个设备，逻辑单元号则表示一个目标设备中的一个子设备。 通常，单个物理磁盘只具有一个逻辑单元号，而RAID磁盘阵列虽然也只有一个目标设备，但却有多个逻辑单元号。

​    在一条总线上各个设备具有不同的优先级。起初的SCSI 协议只允许有8个目标设备ID，规定ID7 具有最高权限。后来版本的SCSI 协议允许有16个不同的目标设备ID。出于兼容性的考虑，从7到0的目标设备依然具有高优先级，而从15到8的设备ID具有较低优先级。

​    设备（服务器和存储设备）在可以通过SCSI 总线发送数据之前必须预定总线（仲裁）。 在总线的仲裁期间，具有最高优先权的目标设备总能获胜。 在总线负载重的情况下，这可能导致具有较低优先级的设备总是不被允许发送数据，因此，SCSI的仲裁过程是不平等的。

​    出于配置和管理的需要，操作系统使用总线号/目标设备ID/逻辑单元号三元组来标识一个SCSI目标，然而用户和应用程序所看到的只是一个逻辑标识符，如D盘。 因此在总线号/目标设备ID/逻辑单元号和逻辑盘符之间存在着一个映射，提供在物理设备和上层文件系统之间不同表示形式的转换。

 

 

3.4 交互方式

   SCSI协议把发起方 (主机)和目标方 (例如磁盘)之间的交互定义为客户/服务器方式。应用客户位于主机中，代表上层应用程序、文件系统和操作系统的 I/0 请求。设备服务器位于目标设备中，它响应客户的请求。请求和响应通过某种形式的下层分布设施进行传输，该分布设施称作分布子系统，可以是并行电缆，也可以是光纤通道协议或iSCSI。

​    一个发起方可能会有多个请求同时发给目标方。多个请求产生应用客户的多个实例，从而在设备服务器上产生多个事务。

​    发起方在其发往一个或多个目标的多个请求正在被相关的设备服务器处理的时候，需要能够执行上下文交换 (Context Switching)，即具有从一个任务快速切换到另一个任务的能力。例如，作为一个发起方的文件服务器可以向一个目标方发送一个写请求。‘当该文件服务器在等待这个目标方准备好缓冲区以接收数据的那段时间内，可以切换到另一个挂起的任务，例如处理已经到达的对先前的另一个请求的响应，从而提高运行效率，最大化吞吐量。如果SCSI任务只能依次串行地执行，那么等待每个写或读请求完成的时间就都被白白地浪费了。一般来说，上下文交换是由主机适配卡完成的，可以是并行 SCSI，也可以是光纤通道或iSCSI。

​    由于 SCSI体系结构模型是层次化的，因此它对主机I/0请求的处理可以独立于底层的分发子系统。一个应用客户主机可以处理涉及不同种类的目标设备的 I/0 操作，例如一个应用服务器可以有直接附接的 SCSI 目标方，也可以有通过千兆位速率接口连接的串行SCSI 目标方。

​    在SCSI发起方和目标方之间读写数据是通过SCSI命令、分发请求、分发操作和响应来完成的。SCSI命令和参数在 CDB (Command Descriptor Block，命令描述块)中指定。作为交互示例，在执行对磁盘的 SCSI写过程时，在发起方 (例如主机总线适配器)创建一个应用客户，该客户发送SCSI命令请求给目标方，令其准备缓冲区以接收数据。目标设备服务器在其缓冲区准备好之后，发送一个数据分发操作请求进行响应。接着，发送方就执行分发操作，开始发送数据块。依赖于底层的分发子系统，数据块可能按字节并行传输 (例如并行 SCSI 总线)，也可能以分段成帧的形式串行传输 (例如光纤通道或iSCSI)。

​    从应用程序或操作系统的角度看，写操作只是一个事务。但实际上，对应一个写操作，发送方和目标方可能要进行多次的分发请求和分发操作的交互，才能把命令请求的所有数据都发送给目标方。

​    在一次读操作中，SCSI命令块遵循相反的数据分发请求和确认序列，然而由于是发起方发出读命令，所以命令就假定自己已经准备好了缓冲区以接收第 1 批数据块。在读写事务的每个阶段所发送的数据块数量，由发起方和目标方根据对方的缓冲区容量协商决定。例如，高性能磁盘阵列一般都能提供较大的缓冲区，可以完成大规模的数据传送，从而提高了产品性能。

 

3.5 SCSI总线信号

​    SCSI在物理信号的基础上定义了一组总线信号。这些信号可划分为数据信号和控制信号两类。它们都是二进制信号，并且只有“真”和“伪”两个稳定状态。其中有指示总线已经被占用的“BSY”信号，有清除并重新设置SCSI总线的“RST”信号等。

 

下面对这些信号的名称和功能逐一进行介绍。

\1. BSY (Busy，忙)信号

  该信号是“或态”信号，表示已经有设备占用总线。

\2. SEL (Select，选择)信号

  该信号是“或态”信号，由发起方用以选择目标方，或者由目标方用以重新选择发起方。

\3. C/D (Control/Data，控制/数据)信号

  该信号由目标方驱动，表示在数据总线上传送的是数据信号还是控制信号。该信号处于真状态时表示控制信号。

\4. I/O(Input/Output，输入输出)信号

​    该信号由目标方驱动，控制数据在数据总线上的移动方向。当 I/0 信号为“真”时表示是对发起方的输入，数据由目标方向发起方传送；若I/0信号为“伪”，则表示数据由发起方向目标方传送。该信号也被用来区分选择和重选阶段。

\5. MSG (Message，通信)信号

  该信号由目标方驱动，表示总线处于信息传送的通信阶段。

\6. REQ (Request，请求)信号

  该信号由目标方驱动，表示有信息传输请求，请求一个 REQ/ACK 数据传送握手过程。

\7. ACK (Acknowledge，应答)信号

​    该信号由发起方驱动，表示对REQ信号的应答。

\8. ATN (Attention，提醒)信号

  该信号由发起方驱动，指示一个提醒信息，表明发起方有一个消息要给目标方发送。

\9. RST (Reset，重置)信号

  该信号是“或态”信号，表示一个硬件重置状态，指示总线进入重新设置阶段，清除所有使用总线的 SCSI设备。

\10. DB (DataBus，数据总线)信号

  DB 信号有两种，分别是用于 8 位数据总线的 DB (7-0，P)和用于 16 位数据总线的DB (l5~O，P)。这些信号都用于传送信息的值，它们包括数据比特信号，加上奇偶检验比特信号。

​    由于在SCSI总线上挂有多个设备，一些控制信号可能同时被多个SCSI设备驱动。这些信号被称作“或态”信号。对于“或态”信号，SCSI设备不会主动将其驱动成“伪”，而是依赖总线终接器，在总线上的所有设备都没有驱动该信号时将其设置成“伪。”只要有 1个或多个设备驱动该信号，该信号就是“真”。与“或态”信号相对照的是“非或态”信号。对于“非或态”信号，SCSI设备可以将其驱动成“伪”。

 

3.6 SCSI 总线的使用阶段

​    根据对总线不同的使用，可以把SCSI总线状态划分成8个不同的阶段：空闲阶段，仲裁阶段，选择阶段，重选阶段，命令阶段，数据阶段，状态阶段和通信阶段。

​    其中命令阶段，数据阶段，状态阶段和通信阶段都设计信息在总线的传送，所以又称为：信息传送阶段。

​    除了空闲阶段外，其他阶段的总线都被SCSI设备占用。

 

3.6.1. 总线空闲阶段

​    总线空闲表明没有一个设备在使用 SCSI 总线，也表示在此状态下，SCSI 设备如果需要，可以使用总线。SCSI设备需要在总线上的 SEL信号和 BSY信号都是“伪”之后，才可以检测总线是否处于空闲状态。

 

作为例子，SCSI总线可能在下列情况下进入空闲状态：

  1.RST信号被设置；

1. 不成功的总线选择或重选；
2. 目标设备解除连接；
3. 目标设备命令完成。

  一旦一个SCSI设备确定总线处于空闲阶段，它就可以申请总线仲裁，从而进入仲裁阶段。

 

3.6.2. 总线仲裁阶段

​    在 SCSI总线上的设备必须先获得总线连接权，然后才可以进行其他的操作。在默认条件下，看似挂在总线上的设备在逻辑上是与总线断开的，没有参与总线上的活动。SCSI设备只有在需要进行数据传输和设备状态报告时才会申请总线连接权。SCSI设备一旦得到了总线连接权，就将在发起方和目标方之间形成一个物理连接的通道，然后就可以进行数据传输。

​    一般情况下，总线的获取与对目标方的选择都由发起方完成。为了更加高效地使用总线，在某些情况下，例如在有较长时间的CPU处理等待或设备存取等待时，需要释放总线以供其他设备使用。在等待的相关任务完成后，再重新进行总线仲裁和连接权获取操作，以继续进行暂停的工作。因此，有时目标方也可以执行总线操作和连接权获取操作，准确地讲，是再获取操作。

​    SCSI总线上的设备的优先级是由它的地址即 SCSI ID 决定的。在窄 SCSI 中的 ID 范围是 0-7，对应的优先级是从 1 到 8。在宽 SCSI 中的ID范围是O~l5，其中对应 IDO~7的优先级是从9到 16递增，而对应 ID8~l5 的优先级是从 1 到 8 递增。在这里，我们用较大的数值表示较高的优先级，因此，ID7具有最高优先级。在窄 SCSI 中，ID 0具有最低优先级；在宽SCSI中，ID8具有最低优先级。

​    SCSI总线上的 ID数目是与 SCSI数据总线宽度一致的，因此，窄 SCSI有8个ID，宽 SCSI有 16个ID。在窄 SCSI 中的 8根数据线的编号是从0到 7，在宽 SCSI 中的 16根数据线的编号是从 0到 15。有趣的是，具有某个编号的数据线上的信号，还被用来表示具有对应号码ID 的 SCSI设备是否在执行选择或相关操作。例如当数据总线中的数据线DB (2)在某个特定的阶段被驱动成真时，就可以表示其ID为 2 的设备已经在总线上执行了选择或相关操作。

​    在SCSI域中，主机是存储设备的主要使用者，且对存储的响应要求较高， 因此通常主机的优先级最高，其分配的ID值也最大，在窄 SCSI 中是 ID 7，在宽 SCSI 中是IDl5。

​    总线仲裁就是在可能同时有多个设备请求的情况下，最终只给予其中的一个 SCSI设备总线控制权的过程。SCSI设备在检测到“总线空闲”并等待一个时延后即可以把总线置成BSY，并把与它的 SCSI ID对应的数据线信号置为“真”，开始总线仲裁申请。

​    在等待 1 个时延后，该SCSI设备需检测在数据总线上是否有更高优先级的 SCSI ID也为“真”。如果总线上确有更高优先级的设备在进行总线申请，则该 SCSI 设备不再置BSY和对应的数据线为“真”。放弃总线仲裁申请，直到下一次“总线空闲”；否则，该设备就获得了总线控制权，并由该设备把SEL信号置为“真”。同时，总线上的其他SCSI设备则检测到 SEL信号为“真”后，不再置BSY信号和对应的数据线为“真”，放弃总线仲裁申请。为了保证确实已经获得了总线控制权，该设备在置SEL信号为“真”后、传送其他信号前，需要有一定的时延。

​    在总线仲裁阶段结束时，总线上有BSY、SEL和与获得总线的 SCSI设备的 ID，其对应的数据线的信号为“真”。

 

3.6.3. 选择阶段

​    在选择阶段，得到总线使用权的SCSI设备在总线上选择目标设备，以便随后可以向该目标设各发送诸如读和写这样的命令。这个阶段主要是完成对具有特定SCSI ID的设备的选择，其相关协议的定义主要是在SCSI体系结构的互连层。需要注意的是，逻辑单元号LUN的寻址是逻辑单元通过SCSI传输层协议完成的，不在互连层。与LUN编址相关的协议在传输协议层描述。

​    赢得仲裁的SCSI设备在把BSY和SEL信号置成“真”，经过一小段时延后，即可进入选择阶段。作为发起方，赢得仲裁的SCSI设备不可以把1/0信号置成“真”。在此阶段，发起方需要把与自己的SCSI ID对应的数据线的信号和对应所要选择的目标设备的SCSI ID的数据线的信号置成“真”，经过一小段时延，再把BSY信号置成“伪”，然后等待目标方的响应。

​    例如，SCSI ID为6的主机把对应自己的ID的数据线DB(6)和对应目标设备的ID(=6)的数据线DB(0)置成“真”后，数据总线上信号值的状态将如下所示。

   DS ( 0) DS (1) DS (2) DS (3 ) DS (4) DS (5) DS (6) DS (7)

   1      0      0      0     0      0      1     0

 

​    此时，只有两个数据线的信号值是“真”。如果有多于两个的数据线为“真”，则目标方认为有误。目标方在SEL和对应它的ID的数据线的信号为“真”并且BSY和I/0信号为“伪”的情况下，就可以确定它自己已经被选为目标设备。此时，目标方设备应该重新把BSY信号置成“真”。发起方在检测到BSY为“真”的信号后，就把SEL信号置成“伪”。特别需要注意的是，在该阶段结束时，BSY信号是由目标方置位的。

 

3.6.4. 重选阶段

​    在 SCSI 目标设备忙于处理其内部事务 (通常是对于执行对存储数据的读或写操作)期间，它可以在等待操作 (比如把存储在设备中的数据读入缓冲区或把暂存在缓冲区的数据写入缓冲区)完成时释放总线供其他设备使用，并在操作完成后重新申请对总线的使用权。因此，重选阶段也发生在“总线仲裁阶段”之后。但与选择阶段不同，重选阶段由目标方启动，重新建立由发送方启动成功但被目标方挂断的连接。

​    在目标设备释放了总线之后，BSY和 SEL信号处于被置成“真”的状态。此时日标设备通过把I/0信号置成“真”使自己成为赢得对总线使用权的一方。在重选阶段，目标方也需要把与自已的 SCSI ID 对应的数据线的信号和对应发送方设备的 SCSI ID的数据线的信号置成“真”，经过一段短的时延，再把BSY信号置成“伪”，然后等待发起方的响应。

​    发起方在SEL、I/0和对应它的 ID 的数据线的信号为“真”并且BSY为“伪”的情况下，就可以确定它自己已经被重选。被重选的发起方可以通过查看数据总线来验证重迭的目标方的 SCSI ID。然后，发起方设各重新把BSY信号置成“真”。目标方在检测到BSY为“真”的信号后，它也执行把BSY驱动成“真”的操作，并把 SEL信号置成“伪”。

​    被重选的发起方在检测到 SEL信号为“伪”后，它就把BSY置成“伪”，而目标设备则继续把 BSY 设置成“真”，直到它放弃对总线的使用权为止。这样，在该阶段结束时，信号的状态与选择阶段一样，也是由目标方设置的BSY信号。

 

3.6.5. 信号传送阶段

​    命令阶段、数据阶段、状态阶段和通信阶段被组合在一起作为信息传送阶段，因为它们都被用来通过数据总线传送数据或控制信息。SCSI 使用 C/D、I/0 和 MSG信号区分不同的信息传送阶段以及对应的信息传输方向。目标方驱动这3个信号，控制从一个阶段到另一个阶段的转变。发起方可以通过把ATN信号置成“真”请求一个“通信出”阶段，而目标方可以通过释放MSG、C/D、I/0 和 BSY信号引入总线空闲阶段。信息传送阶段使用一个或多个REQ/ACK握手过程控制信息传送。每个REQ/ACK握手过程允许传送 1个或多个字节的信息。因为信息传送阶段一定是在选择阶段或重选阶段之后，所以不改变BSY和 SEL信号。事实上，在该阶段，BSY持续为“真”，SEL信号持续为“伪”。

   

​    表2-2 示出了 MSG、C/D和I/0信号值与阶段名及信息传输方向之间的关系。其中的“出”和“入”是相对子发送方设备而言的，且数据传输方向由I/0信号确定。

 

表 2-2 MSG、C/D和 1/0信号值与阶段名及信息传输方向之间的关系

| MSG  | CID  | 1/0  | 阶段     | 具体阶段         | 传输方向         |      |      |      |
| ---- | ---- | ---- | -------- | ---------------- | ---------------- | ---- | ---- | ---- |
| 1    | 0    | 0    | * (未用) |                  |                  |      |      |      |
| 1    | 0    | 1    | * (末用) |                  |                  |      |      |      |
| 1    | 1    | 0    | 通信     | 通信出           | 从发送方到目标方 |      |      |      |
| 1    | 1    | 1    | 通信     | 通信入           | 从目标方到发送方 |      |      |      |
| 0    | 0    | 0    | 数据     | 数据出           | 从发送方到目标方 |      |      |      |
| 0    | 0    | 1    | 数据     | 数据入           | 从目标方到发送方 |      |      |      |
| 0    | 1    | 0    | 命令     | 从发送方到目标方 |                  |      |      |      |
| 0    | 1    | 1    | 状态     | 从目标方到发送方 |                  |      |      |      |
|      |      |      |          |                  |                  |      |      |      |

注释：0=伪，1=真，*=保留未来定义

 

​    命令阶段允许目标方请求发起方传送命令信息。在命令阶段的 REQ/ACK 握手过程中，目标方把C/D信号置成“真”，把I/0信号和MSG信号置成“伪”。

​    数据阶段包括“数据入”阶段和“数据出”阶段。

（1）“数据入”阶段允许目标方请求把数据从目标方传送给发起方。在“数据入”阶段的 REQ/ACK 握手过程中，目标方把I/0信号置成“真”，把C/D信号和MSG信号置成“伪”。

（2）“数据出”阶段允许目标方请求把数据从发起方传送到目标方。在“数据出”阶段的 REQ/ACK 握手过程中，目标方把C/D信号、I/0信号和 MSG信号都置成“真”。

   

​    状态阶段允许目标方请求把状态信息从目标方传送给发起方。在状态阶段的REQ/ACK握手过程中，目标方把C/D信号和I/0信号置成“真”，把MSG信号置成“伪”。

​    通信阶段可以是“通信入”阶段或“通信出”阶段。无论是在“通信入”阶段，还是在“通信出”阶段，都可以传送多条消息。传送的第一个字节可以是单字节消息，也可以是多字节消息的首字节。在 1 个通信阶段可以传送多个多字节消息。

​    “通信入”阶段允许目标方请求把消息从目标方发送给发起方。在“通信入”阶段的 REQ/ACK握手过程中，目标方把C/D信号、I/0信号和 MSG信号都置成“真”。

  “通信出”阶段允许目标方请求把消息从发起方传送到目标方。目标方在响应发起方建立的提醒条件时调用“通信出”阶段。在“通信出”阶段的 REQ/ACK 握手过程中，目标方把C/D信号和 MSG信号置成“真”，把I/0信号置成“伪”。

 

3.7 异步传输和同步传输

​    与传统网络的数据包传送方式不同，SCSI 基于REQ/ACK 信号控制数据传输的过程。 根据REQ和ACK信号控制与数据总线置位时间的差别，信息传输又可分为异步传输和同步传输两个列别。 而且，无论传输的方向如何，信息的传输都是由REQ信号开始，并且REQ信号都是由目标方控制和发送的。

 

\1. 异步信息传输

​    异步传输方式可用于数据阶段的数据传输，也可用于命令、状态和通信阶段的信息传输。首先，信息传输的方向是由 I/O信号决定的。如果 I/O信号为“真”，那么信息是由目标方向发起方传输。在此情况下，为了传送信息，目标方先把数据线 DB(7/15-0，P)信号置成对应想要传送的二进制数位序列的值，然后把REQ信号置成“真”。 发起方在检测到REQ为“真”时，读取数据总线的值，然后把ACK信号置成“真”。当目标方检测到ACK为“真”时，它就可以改变或取消放置在数据总线上的值，并把REQ置成“伪”。发起方在检测到REQ置成“伪”时把ACK也置成“伪”。当目标方检测到ACK为“伪”时，总线上就完成了一次数据传输，并可进行下一次数据传输。

​    在异步传输方式中，每个REQ/ACK握手过程传送 1个(对于窄 SCSI)或 2 个字节(对于宽 SCSI)的信息。特别需要注意的是，在此方式中，目标方在置 REQ 信号后，必须持续地把数据线 DB (7/l5~O，P)置成对应所要传送的二进制数位序列的值，直到它检测到ACK为真为止。

​    如果I/O信号为“伪”，那么信息是由发起方向目标方传输。在此情况下，目标方通过把REQ置成“真”来请求信息。发起方驱动 DB (7/l5~O，P)到它需要发送的二进制数位序列的值，然后把 ACK置成“真”。此后，继续把 DB (7/l5~O，P)信号置成这个二进制数位序列的值，直到 REQ 变成“伪”为止。目标方则是在检测到 ACK变成“真”时，读 DB (7/l5~O，P)的值，然后把 REQ 置成“伪”。发起方在检测到REQ变成“伪”时，它可以改变或取消放置在数据总线上的值，并把ACK置成“伪”。

​    此后，目标方可以通过把REQ置成“真”，继续请求信息。

 

\2. 同步数据传输

​    同步数据传输只在数据阶段使用，并且是在目标方和发起方之间建立同步数据传输协定之后使用。

​    与异步传输中的规则相同，当 I/0 信号为“真”时，数据是由目标方向发起方传输。目标方先把数据放置到数据总线上，即置 DB (7/l5~O，P)对应的线路，然后把REQ置成“真”。在同步数据传输中，目标方在把REQ置成“真”后，需要把放置在DB (7/l5~O，P)上的二进制数位序列的值保持一个指定长度的时间，但不必维持到对ACK信号变“真”的接收。这是与异步传输不同的一个地方。在指定长度的时间期满后，目标方就可以把 REQ 置成“伪”，并且可以改变或取消放置在数据总线上的值，然后准备发送下一个数据。发起方在检测到REQ变“真”之后一个指定长度的时间内读DB (7/l5~O，P)上的值，然后把ACK置成“真”作为对目标方的响应。

​    与异步传输一样，在同步数据传输中，发起方也在接收到一个REQ并读取了数据总线上的值之后就发送一个ACK信号。但与异步传输不同的是，目标方在接收到对一个数据的ACK之前可以发送多个REQ信号。SCSI为同步数据传输的REQ/ACK握手过程定义了一个称作REQ/ACK饱和值的参数，它表示在接收到ACK信号前可以发送的最大REQ信号数。如果发送的REQ数日多于接收到的ACK数目，并达到了定义的REQ/ACK饱和值，那么目标方暂停发送REQ信号和数据，直到接收到下一个ACK为止。这在原理上与传统网络中的流控制类似。  

​    当 I/O信号为“伪”时，数据是由发起方向目标方传输。发起方每次接收到一个REQ信号就发送一次数据。目标方先把REQ置成“真”。发起方检测到REQ变“真”后把要发送的数据放置到数据总线上，即置DB (7/l5~O，P)对应的线路，然后把ACK置成“真”。接着发送方需要在一个指定长度的时间内保持在总线上放置的数据不变， 并继续把ACK置成“真”。在指定的时间期满后，发起方可以把ACK置成“伪”，并且可以改变或取消放置在数据总线上的值。目标方在检测到ACK信号变“真”后，在指定的ACK保持为“真”的时间内读取数据总线上的数据，并把REQ置成“伪”。

​    此后，目标方可以通过把REQ再置成“真”继续请求信息。

 

3.8 SCSI 命令描述块

​    在互连层完成 SCSI设备对总线的连接，以及发送方和目标方的选择的基础上，传输层协议执行实际的数据传输。传输层提供了两类服务，一是命令的执行和确认；二是数据的传送。命令的执行是在总线进入命令阶段后，发起方通过命令描述块(command description block，CDB)向目标方发送具体的命令。命令的确认是在总线进入通信 (Message)阶段后，发起方接收由目标方发送的命令执行确认信息。数据的传送则是在数据阶段 (数据出或数据入)进行的。传输协议的运行过程包括发送命令、传输数据和对命令执行的确认。SCSI基础命令规范  SPC (SCSI Primary Commands，SCSI基础命令)定义了 CDB 的标准。

​    除了基本命令外，SPC还定义了所有类型的 SCSI 目标方设各都可以使用的管理参数，如诊断参数和日志参数等。

​    发起方对存储设备的实际操作是通过向目标方发送一个命令描述块来完成的。在一些情况下，在一个命令描述块之后可能还有一些参数要传给目标方，按照具体的协定，这些更多的参数是在命令描述块后的“数据出”阶段发送的。命令描述块有定长和不定长两种格式，而定长格式的命令描述块又有 6、10、12或 16字节不同的长度规定。

 

命令描述块由编号从0~5 的 6个字节组成。下面介绍其中各个段的内容。

\1. 操作码

​    操作码是所有命令描述块都有的，它总是被放在命令描述块的开头一个字节。正如其名字所言，操作码定义CDB 的具体操作。8 比特在理论上共有256个可能的操作码。实际上其中有一些是保留码，日前尚未定义。操作码的 8 个二进制位又分为两部分：5-7位是组代码，指示该命令具体属于哪个命令组，它决定 CDB 的长度，如“000”为组“0”，表示6个字节的CDB命令组，0-4位则是具体的命令代码。

 

\2. 混杂CDB信息

​    该参数表示与具体的CDB相关的信息，其中一个例子是表示逻辑设备号，寻址在SCSI 目标设备中的一个逻辑单元。对应一个SCSI ID 的设备可以有多个逻辑单元，所以逻辑单元扩展了 SCSI总线可访问的设备数目，使得目标方设各上可以有多个可被访问的设备而只占用一个有效的 SCSI ID。对一个逻辑单元的实际访问是通过该逻辑单元的一个特定的编号，即逻辑单元号实现的。

 

\3. 逻辑块地址

​    该地址是逻辑单元 (比如磁盘)中的起始操作块的位置。在 6 字节的CDB 中，有21 位的逻辑块地址。SCSI把逻辑单元、卷或分区抽象成块的数组，每一块都有一个逻辑地址，编号从 0 开始。对 SCSI 存储设备的每一次读/写操作都是针对一组连续的逻辑块进行的，因而需要指出起始块的逻辑地址。

 

\4. 传送长度

​    该长度表示命令所请求的传送量，通常是块数。在有些类别的 CDB 中也可能是字节数。0表示不需要传送数据。

 

\5. 参数表长度

​    有些命令还需要更多的参数，这些参数由客户提供，定义在“数据出”缓冲区中。参数表长度就表示需要传送到存储设备的这类参数的长度，0表示不需要传递参数。

 

\6. 分配长度

​    分配长度表示应用客户为“数据入”缓冲区分配的最大长度，根据具体的CDB类别，可能是字节数，也可能是块数。应用客户通常使用该“数据入”缓冲区接收特殊信息，如日志数据、诊断数据等。如果传送的信息量超过了分配长度表示的最大值，则相关设备不应再传，并使用状态阶段返回特定的状态信息。

 

\7. 控制码

​    它是所有 CDB 格式的最后一个字节。在其中有一些特殊的域，如已经定义的一个NACA位。在一些情况下，一个命令的执行会以“检查条件 (Check Condition)”状态中止，它表明在命令执行过程中出现了错误或异常。 有些命令执行的错误或异常不会影响其他命令的执行，也不需要作善后的恢复处理，而另一些命令执行的错误或异常则可能导致命令组中的其他命令被异常中止，需要专门的命令对其做善后处理，并要求存储设各在完成善后处理工作之前不再处理该用户的其他命令。为了区分这两种不同的情况，也为了让应用客户能够事先声明哪些命令执行的错误或异常需要善后处理，SCSI允许应用客户在CDB 的控制码中设置NACA位，请求存储设备在命令执行以“检查条件”状态中止时建立“自动跟随”条件 (Condition)，从而允许应用客户在随后的善后处理命令中把新 (New)任务的属性设置成自动跟随 (Auto ContingentAllegiance，ACA)。

 

3.9 SCSI 的读操作和写操作过程

\1. SCSI的读操作过程

​    如果计算机要从存储设备上读取文件或数据，那么无论数据的大小如何，都至少要经历一个SCSI的读操作过程。当然，操作系统需首先将用户的读取操作通过 SCSI I/0的应用程序编程接口 (Application Programming Interface，API)转化为 SCSI的读操作，并在操作完成后通过相应的API返回响应的值。

 

在SCSI域内，这个操作在传输层被简单地描述成 5个主要过程：

  (1)发起方通过CDB发送SCSI的读命令。

  (2)目标方接收到该命令，通过设备管理器在指定的逻辑单元中执行该命令请求的操作。

  (3)目标方以字节为单位向发起方传送数据。

  (4)在数据传输完毕后，目标方向发起方发送命令完成的报告。

  (5)发起方接收到命令完成的响应。

 

​    当然，这些过程是建立在 SCSI 互连层的基础上的。在第一个过程之前，SCSI 总线由空闲阶段进入总线仲裁和选择阶段，完成发起方对总线使用权的获得以及对目标方的选择和寻址。

​    在第一个过程中，目标方发送REQ信号，请求信息传输，控制总线进入信息传送的命令阶段。目标方通过发送方传送的 CDB获取“读”命令。在其后的第 2 个和第 3个 过程中，目标方从它控制的外围设备中读取数据并发送到发起方。如目标方准备数据需要较长的时间，则可能有多个总线释放、进入空闲和重选阶段的轮回。目标方 在每次完成数据传送后，都控制总线进入状态阶段并返回一个状态信息。为进一步表示读命令的全部完成，在第四个过程中，总线进入信息传送的通信阶段，目标方 发送“命令完成”信息，并可释放 SCSI 总线的 BSY信号。在第五个过程中，发起方接收到日标方命令完成的响应，总线可恢复到空闲阶段。

 

\2. SCSI的写操作过程

​    SCSI的写操作过程与读操作过程类似，但数据传送的方向不同，它把数据从发送方向目标方传送。在发送方系统中有对文件做写操作的用户请求时，它先通过文件系统查找该文件在存储设备 (如磁盘)上的逻辑块地址 (Logical BlockAddress，LBA)，接着文件系统把该LBA连同其他一些参数，如数据的指针、数据的长度以及逻辑单元号等传递给SCSI 的 API，并指示一 个写操作。例如写 6000字节到 LUNO 的逻辑块地址OOOl234AB。SCSI的API则具体发送一个写命令给LUNO，并将数据以存储设备认可的方式分批或一次性地传递到 LUNO，直到数据全部传输完毕。之后，SCSI 的 API返回，并指示任务完成。然后，文件系统通知应用程序任务完成。至此，一个文件的写操作完成。

当然，在数据写操作中，仍然需要具体运行SCSI的各个阶段，并需要发送SCSI信号以及SCSI命令，如写命令等。这些方面都与上面描述的读操作类似，此处不再赘述。

   

​    从上面的介绍可以看出，一个简单的数据读或写操作会涉及一系列的过程。实际上，在这些过程中，除了有应用程序 (如字处理软件、数据库等)为用户提供的直接操作界面和操作系统给应用程序提供的通用的系统功能外，还有文件系统、SCSIAPI、SCSI设备命令、SCSI驱动程序、总线和存储设备等多种软硬件的参与。

### 引用

0. https://www.cnblogs.com/zxqstrong/p/4727912.html

1. https://blog.51cto.com/dcx86team/904499
2. https://www.jianshu.com/p/82eee3b3010c
2. https://blog.csdn.net/karamos/article/details/80127024
2. https://blog.csdn.net/liukuan73/article/details/45506441